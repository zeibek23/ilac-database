<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacokinetics Module</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .select2-container {
            width: 100% !important;
        }
        .select2-container--bootstrap-5 .select2-selection {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            height: 38px;
            padding: 0.375rem 0.75rem;
        }
        .chart-container {
            max-width: 100%;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
        }
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .therapeutic-range {
            background-color: rgba(0, 255, 0, 0.1);
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .table {
            font-size: 0.9rem;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .alert {
            border-radius: 8px;
        }
        .dose-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .metabolite-list {
            font-size: 0.85rem;
            color: #495057;
        }
        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
            }
            .table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Pharmacokinetics Module</h1>

        <!-- Drug Search Card -->
        <div class="card p-4 mb-4">
            <div class="row">
                <div class="col-md-6 mx-auto">
                    <label for="drug_search" class="form-label fw-semibold">Search Drug</label>
                    <select id="drug_search" name="drug_id" class="form-select">
                        {% if selected_drug %}
                        <option value="{{ selected_drug.id }}" selected>
                            {{ selected_drug.name_en }} ({{ selected_drug.name_tr or "N/A" }})
                        </option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        {% if error %}
        <div class="alert alert-danger text-center">{{ error }}</div>
        {% endif %}

        <!-- Visualizations and Data -->
        {% if pk_data %}
        <div class="row g-4">
            <!-- Radar Chart -->
            <div class="col-lg-6">
                <div class="chart-container card p-4">
                    <h3 class="chart-title text-center">PK Profile</h3>
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- Concentration Chart -->
            <div class="col-lg-6">
                <div class="chart-container card p-4">
                    <h3 class="chart-title text-center">Concentration Over Time</h3>
                    <canvas id="concentrationChart"></canvas>
                    <div class="dose-controls mt-3">
                        <div class="input-group w-auto">
                            <span class="input-group-text">Dose (mg)</span>
                            <input type="number" id="dose" value="{{ request.args.get('dose', 100) }}" min="1" class="form-control" style="width: 100px;">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="steadyState" class="form-check-input">
                            <label for="steadyState" class="form-check-label">Steady State</label>
                        </div>
                        <div class="input-group w-auto">
                            <span class="input-group-text">Interval (h)</span>
                            <input type="number" id="interval" value="8" min="1" class="form-control" style="width: 100px;">
                        </div>
                        <div class="input-group w-auto">
                            <span class="input-group-text">Route</span>
                            <select id="routeSelect" class="form-select" style="width: 150px;">
                                <option value="-1">All</option>
                                {% for entry in pk_data %}
                                <option value="{{ loop.index0 }}">{{ entry.route_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button id="optimizeDose" class="btn btn-primary">Optimize Dosing</button>
                        <button id="resetDose" class="btn btn-secondary">Reset Dose</button>
                    </div>
                    <div id="dosingRecommendation" class="mt-3 text-center text-muted"></div>
                </div>
            </div>

            <!-- Bioavailability Chart -->
            <div class="col-lg-6">
                <div class="chart-container card p-4">
                    <h3 class="chart-title text-center">Bioavailability by Route</h3>
                    <canvas id="bioavailabilityChart"></canvas>
                </div>
            </div>

            <!-- AUC Chart -->
            <div class="col-lg-6">
                <div class="chart-container card p-4">
                    <h3 class="chart-title text-center">AUC by Route</h3>
                    <canvas id="aucChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PK Data Table -->
        <div class="card p-4 mt-4">
            <h3 class="chart-title">Pharmacokinetic Parameters</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Route</th>
                            <th>Absorption (%/h)</th>
                            <th>Vd (L)</th>
                            <th>Protein Binding (%)</th>
                            <th>Half-Life (h)</th>
                            <th>Clearance (mL/min)</th>
                            <th>Bioavailability (%)</th>
                            <th>Tmax (h)</th>
                            <th>Cmax (mg/L)</th>
                            <th>Therapeutic Range</th>
                            <th>AUC (mg/L·h)</th>
                            <th>Metabolites</th>
                            <th>Metabolism Organs</th>
                            <th>Metabolism Enzymes</th>
                            <th>Pharmacodynamics</th>
                            <th>Pharmacokinetics</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in pk_data %}
                        <tr>
                            <td>{{ entry.route_name }}</td>
                            <td>
                                {% if entry.absorption_rate_min == entry.absorption_rate_max %}
                                {{ entry.absorption_rate_min }}
                                {% else %}
                                {{ entry.absorption_rate_min }} - {{ entry.absorption_rate_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.vod_rate_min == entry.vod_rate_max %}
                                {{ entry.vod_rate_min }}
                                {% else %}
                                {{ entry.vod_rate_min }} - {{ entry.vod_rate_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.protein_binding_min == entry.protein_binding_max %}
                                {{ entry.protein_binding_min }}
                                {% else %}
                                {{ entry.protein_binding_min }} - {{ entry.protein_binding_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.half_life_min == entry.half_life_max %}
                                {{ entry.half_life_min }}
                                {% else %}
                                {{ entry.half_life_min }} - {{ entry.half_life_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.clearance_rate_min == entry.clearance_rate_max %}
                                {{ entry.clearance_rate_min }}
                                {% else %}
                                {{ entry.clearance_rate_min }} - {{ entry.clearance_rate_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.bioavailability_min == entry.bioavailability_max %}
                                {{ entry.bioavailability_min }}
                                {% else %}
                                {{ entry.bioavailability_min }} - {{ entry.bioavailability_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.tmax_min == entry.tmax_max %}
                                {{ entry.tmax_min }}
                                {% else %}
                                {{ entry.tmax_min }} - {{ entry.tmax_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.cmax_min == entry.cmax_max %}
                                {{ entry.cmax_min }}
                                {% else %}
                                {{ entry.cmax_min }} - {{ entry.cmax_max }}
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.therapeutic_min == 0 and entry.therapeutic_max == 0 %}
                                N/A
                                {% elif entry.therapeutic_min == entry.therapeutic_max %}
                                {{ entry.therapeutic_min }} {{ entry.therapeutic_unit }}
                                {% else %}
                                {{ entry.therapeutic_min }} - {{ entry.therapeutic_max }} {{ entry.therapeutic_unit }}
                                {% endif %}
                            </td>
                            <td>{{ entry.auc }}</td>
                            <td>
                                {% macro render_metabolites(metabolites, parent_id=None, level=0) %}
                                <ul class="metabolite-list mb-0">
                                    {% for met in metabolites | selectattr('parent_id', 'equalto', parent_id) %}
                                    <li>{{ '  ' * level }}{{ met.name }}</li>
                                    {{ render_metabolites(metabolites, met.id, level + 1) }}
                                    {% endfor %}
                                </ul>
                                {% endmacro %}
                                {% if entry.metabolites %}
                                {{ render_metabolites(entry.metabolites, None) }}
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>{{ entry.metabolism_organs | join(', ') or 'N/A' }}</td>
                            <td>{{ entry.metabolism_enzymes | join(', ') or 'N/A' }}</td>
                            <td>{{ entry.pharmacodynamics }}</td>
                            <td>{{ entry.pharmacokinetics }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-3">
                <a href="/drug/{{ selected_drug_id }}" class="btn btn-outline-primary">View Metabolism Pathway</a>
            </div>
        </div>
        {% elif selected_drug_id %}
        <div class="alert alert-info text-center">No pharmacokinetic data available for this drug.</div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
$(document).ready(function () {
    // Initialize Select2 for drug search (unchanged)
    $('#drug_search').select2({
        theme: 'bootstrap-5',
        placeholder: "Search for a drug...",
        ajax: {
            url: "/api/active_ingredients",
            dataType: 'json',
            delay: 250,
            data: params => ({ q: params.term, limit: 10, page: params.page || 1 }),
            processResults: data => ({
                results: data.results,
                pagination: { more: data.pagination?.more || false }
            })
        },
        minimumInputLength: 1,
        allowClear: true,
        width: '100%',
        templateResult: data => data.text,
        templateSelection: data => data.text || "Search for a drug..."
    }).on('select2:select', e => {
        window.location.href = `/pharmacokinetics?drug_id=${e.params.data.id}&dose=${$('#dose').val()}`;
    }).on('select2:clear', () => {
        window.location.href = '/pharmacokinetics';
    });

    {% if pk_data %}
    const pkData = {{ pk_data | tojson }};
    const chartData = {{ chart_data | tojson | safe }};
    const COLORS = [
        'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 
        'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)', 'rgba(201, 203, 207, 0.6)',
        'rgba(255, 205, 86, 0.6)', 'rgba(54, 162, 235, 0.6)'
    ];

    // Radar Chart (unchanged)
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    const radarChart = new Chart(radarCtx, {
        type: 'radar',
        data: {
            labels: ['Absorption Rate', 'Volume of Dist.', 'Protein Binding', 'Half-Life', 'Clearance Rate'],
            datasets: pkData.map((entry, idx) => ({
                label: entry.route_name,
                data: [
                    (entry.absorption_rate_min + entry.absorption_rate_max) / 2,
                    (entry.vod_rate_min + entry.vod_rate_max) / 2,
                    (entry.protein_binding_min + entry.protein_binding_max) / 2,
                    (entry.half_life_min + entry.half_life_max) / 2,
                    (entry.clearance_rate_min + entry.clearance_rate_max) / 2
                ],
                backgroundColor: COLORS[idx % COLORS.length].replace('0.6', '0.2'),
                borderColor: COLORS[idx % COLORS.length].replace('0.6', '1'),
                borderWidth: 2
            }))
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: {
                r: { 
                    beginAtZero: true, 
                    ticks: { stepSize: 10 },
                    grid: { color: '#e9ecef' }
                }
            }
        }
    });

    // Concentration Chart (updated to use backend chart_data)
    const concentrationCtx = document.getElementById('concentrationChart').getContext('2d');
    const concentrationChart = new Chart(concentrationCtx, {
        type: 'line',
        data: chartData ? chartData.data : {
            labels: pkData[0].concentrations.map(pair => pair[0]),
            datasets: []
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                annotation: {
                    annotations: []
                },
                title: {
                    display: true,
                    text: chartData ? chartData.options.plugins.title.text : 'Concentration vs Time'
                }
            },
            scales: {
                x: { 
                    title: { display: true, text: 'Time (hours)' },
                    grid: { color: '#e9ecef' }
                },
                y: { 
                    title: { display: true, text: 'Concentration (mg/L)' },
                    beginAtZero: true,
                    suggestedMax: 0,
                    grid: { color: '#e9ecef' }
                }
            }
        }
    });

    // Bioavailability Chart (unchanged)
    const bioCtx = document.getElementById('bioavailabilityChart').getContext('2d');
    const bioavailabilityChart = new Chart(bioCtx, {
        type: 'bar',
        data: {
            labels: pkData.map(entry => entry.route_name),
            datasets: [{
                label: 'Bioavailability (%)',
                data: pkData.map(entry => (entry.bioavailability_min + entry.bioavailability_max) / 2),
                backgroundColor: pkData.map((_, idx) => COLORS[idx % COLORS.length]),
                borderColor: pkData.map((_, idx) => COLORS[idx % COLORS.length].replace('0.6', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    max: 100, 
                    title: { display: true, text: 'Bioavailability (%)' },
                    grid: { color: '#e9ecef' }
                },
                x: { 
                    title: { display: true, text: 'Route' },
                    grid: { display: false }
                }
            }
        }
    });

    // AUC Chart (updated to use backend AUC values)
    const aucCtx = document.getElementById('aucChart').getContext('2d');
    const aucChart = new Chart(aucCtx, {
        type: 'bar',
        data: {
            labels: pkData.map(entry => entry.route_name),
            datasets: [{
                label: 'AUC (mg/L·h)',
                data: pkData.map(entry => entry.auc),
                backgroundColor: pkData.map((_, idx) => COLORS[idx % COLORS.length]),
                borderColor: pkData.map((_, idx) => COLORS[idx % COLORS.length].replace('0.6', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: value => value.toFixed(2),
                    color: '#000',
                    font: { weight: 'bold' }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'AUC (mg/L·h)' },
                    grid: { color: '#e9ecef' }
                },
                x: { 
                    title: { display: true, text: 'Route' },
                    grid: { display: false }
                }
            }
        }
    });

    function calculateConcentration(dose, entry, time, steadyState = false, interval = 0) {
        const halfLife = (entry.half_life_min + entry.half_life_max) / 2 || 1;
        const vod = (entry.vod_rate_min + entry.vod_rate_max) / 2 || 1;
        const bio = (entry.bioavailability_min + entry.bioavailability_max) / 2 / 100;
        const ke = Math.log(2) / halfLife;
        let concentrations = Array(time.length).fill(0);

        if (steadyState && interval > 0) {
            const doses = Math.ceil(time[time.length - 1] / interval);
            const R = 1 / (1 - Math.exp(-ke * interval)); // Accumulation ratio
            for (let d = 0; d < doses; d++) {
                const doseTime = d * interval;
                const c0 = (dose * bio) / vod;
                time.forEach((t, i) => {
                    if (t >= doseTime) {
                        concentrations[i] += c0 * Math.exp(-ke * (t - doseTime)) * R;
                    }
                });
            }
        } else {
            // Use backend concentrations if available, scaled by dose
            const initialDose = {{ request.args.get('dose', 100) }};
            const scale = dose / initialDose;
            concentrations = entry.concentrations.map(pair => pair[1] * scale);
        }
        return concentrations;
    }

    function calculateAUC(concentrations, time) {
        let auc = 0;
        for (let i = 0; i < concentrations.length - 1; i++) {
            auc += (concentrations[i] + concentrations[i + 1]) * (time[i + 1] - time[i]) / 2;
        }
        return auc;
    }

    function optimizeDosing(entry) {
        const halfLife = (entry.half_life_min + entry.half_life_max) / 2 || 1;
        const vod = (entry.vod_rate_min + entry.vod_rate_max) / 2 || 1;
        const bio = (entry.bioavailability_min + entry.bioavailability_max) / 2 / 100;
        const ke = Math.log(2) / halfLife;
        const clearance = ((entry.clearance_rate_min + entry.clearance_rate_max) / 2) * 0.06; // Convert mL/min to L/h
        let therapeuticMin = entry.therapeutic_min || 0;
        let therapeuticMax = entry.therapeutic_max || 0;
        const unit = entry.therapeutic_unit || 'mg/L';

        // Convert therapeutic range to mg/L
        if (unit === 'ng/mL') {
            therapeuticMin /= 1000;
            therapeuticMax /= 1000;
        }

        const targetCss = (therapeuticMin + therapeuticMax) / 2;
        let interval = Math.round(halfLife); // Round to nearest hour
        let dose = (targetCss * clearance * interval) / bio;
        const time = concentrationChart.data.labels;
        let CssMin, CssMax, maxIterations = 100, iteration = 0;

        do {
            const concentrations = calculateConcentration(dose, entry, time, true, interval);
            CssMin = Math.min(...concentrations.slice(-48)); // Last 24 hours
            CssMax = Math.max(...concentrations.slice(-48));
            if (CssMax > therapeuticMax) dose *= 0.9;
            if (CssMin < therapeuticMin) dose *= 1.1;
            iteration++;
        } while ((CssMin < therapeuticMin || CssMax > therapeuticMax) && iteration < maxIterations);

        return { dose: dose.toFixed(2), interval: interval.toFixed(1), concentrations: calculateConcentration(dose, entry, time, true, interval) };
    }

    function updateConcentrationChart(dose, steadyState, interval, routeIdx = -1) {
        const datasets = [];
        const annotations = [];
        const time = chartData ? chartData.data.labels : pkData[0].concentrations.map(pair => pair[0]);
        let maxConcentration = 0;
        const initialDose = {{ request.args.get('dose', 100) }};

        const entries = routeIdx === -1 ? pkData : [pkData[routeIdx]];

        entries.forEach((entry, idx) => {
            const halfLife = (entry.half_life_min + entry.half_life_max) / 2 || 1;
            const vod = (entry.vod_rate_min + entry.vod_rate_max) / 2 || 1;
            const bio = (entry.bioavailability_min + entry.bioavailability_max) / 2 / 100;
            const ke = Math.log(2) / halfLife;
            const tmax = (entry.tmax_min + entry.tmax_max) / 2 || 1;
            let cmax = (entry.cmax_min + entry.cmax_max) / 2 || ((dose * bio) / vod);
            const unit = entry.therapeutic_unit || 'mg/L';
            let therapeuticMin = entry.therapeutic_min || 0;
            let therapeuticMax = entry.therapeutic_max || 0;

            // Convert to mg/L for chart
            if (unit === 'ng/mL') {
                cmax /= 1000;
                therapeuticMin /= 1000;
                therapeuticMax /= 1000;
            }

            // Therapeutic range annotation
            if (therapeuticMin > 0 && therapeuticMax > 0) {
                annotations.push({
                    type: 'box',
                    yMin: therapeuticMin,
                    yMax: therapeuticMax,
                    backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    borderColor: 'rgba(0, 255, 0, 0.5)',
                    label: { 
                        content: `Therapeutic Range (${entry.route_name})`, 
                        enabled: true 
                    }
                });
            }

            // Parent drug concentrations
            let parentConcentrations = calculateConcentration(dose, entry, time, steadyState, interval);
            datasets.push({
                label: `${entry.route_name} (Parent)`,
                data: parentConcentrations,
                borderColor: COLORS[idx % COLORS.length].replace('0.6', '1'),
                backgroundColor: COLORS[idx % COLORS.length].replace('0.6', '0.2'),
                fill: {
                    target: 'origin',
                    above: COLORS[idx % COLORS.length].replace('0.6', '0.2') // Shaded AUC
                },
                tension: 0.1
            });

            // Tmax and Cmax annotation
            const peakIndex = Math.round(tmax / (time[1] - time[0]));
            const peakConcentration = parentConcentrations[peakIndex] || cmax;
            annotations.push({
                type: 'point',
                xValue: tmax,
                yValue: peakConcentration,
                backgroundColor: COLORS[idx % COLORS.length].replace('0.6', '1'),
                radius: 5,
                label: { 
                    content: `${entry.route_name}: Tmax=${tmax.toFixed(1)}h, Cmax=${peakConcentration.toFixed(2)} ${unit}`, 
                    enabled: true 
                }
            });

            // Metabolite concentrations (with warning for assumptions)
            entry.metabolites.forEach((met, mIdx) => {
                const metKe = ke * 0.8; // Assumption: adjust if backend provides data
                const metDelay = tmax + 1;
                const metFormationFraction = 0.5; // Assumption
                let metConcentrations;
                if (steadyState && interval > 0) {
                    metConcentrations = Array(time.length).fill(0);
                    const doses = Math.ceil(time[time.length - 1] / interval);
                    const R = 1 / (1 - Math.exp(-metKe * interval));
                    for (let d = 0; d < doses; d++) {
                        const doseTime = d * interval;
                        const metC0 = (dose * bio) / vod * metFormationFraction;
                        time.forEach((t, i) => {
                            if (t >= doseTime + metDelay) {
                                metConcentrations[i] += metC0 * Math.exp(-metKe * (t - doseTime - metDelay)) * R;
                            }
                        });
                    }
                } else {
                    metConcentrations = time.map(t => t < metDelay ? 0 : (parentConcentrations[0] * metFormationFraction) * Math.exp(-metKe * (t - metDelay)));
                }
                datasets.push({
                    label: `${met.name} (via ${entry.route_name})`,
                    data: metConcentrations,
                    borderColor: COLORS[(idx + mIdx + 1) % COLORS.length].replace('0.6', '1'),
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                });
            });

            maxConcentration = Math.max(maxConcentration, cmax, therapeuticMax, ...parentConcentrations);
        });

        // Update concentration chart
        concentrationChart.data.datasets = datasets;
        concentrationChart.options.plugins.annotation.annotations = annotations;
        concentrationChart.options.scales.y.suggestedMax = maxConcentration * 1.2 || 10;
        concentrationChart.update();

        // Update AUC chart (using backend AUC values)
        aucChart.data.labels = entries.map(entry => entry.route_name);
        aucChart.data.datasets[0].data = entries.map(entry => entry.auc);
        aucChart.data.datasets[0].backgroundColor = entries.map((_, idx) => COLORS[idx % COLORS.length]);
        aucChart.data.datasets[0].borderColor = entries.map((_, idx) => COLORS[idx % COLORS.length].replace('0.6', '1'));
        aucChart.update();
    }

    // Event listeners
    const doseInput = document.getElementById('dose');
    const steadyStateCheck = document.getElementById('steadyState');
    const intervalInput = document.getElementById('interval');
    const routeSelect = document.getElementById('routeSelect');
    const optimizeButton = document.getElementById('optimizeDose');
    const resetButton = document.getElementById('resetDose');

    if (doseInput && optimizeButton && resetButton && steadyStateCheck && intervalInput && routeSelect) {
        function update() {
            const dose = parseFloat(doseInput.value) || 100;
            const steadyState = steadyStateCheck.checked;
            const interval = parseFloat(intervalInput.value) || 8;
            const routeIdx = parseInt(routeSelect.value);
            updateConcentrationChart(dose, steadyState, interval, routeIdx);
        }

        doseInput.addEventListener('input', update);
        steadyStateCheck.addEventListener('change', update);
        intervalInput.addEventListener('input', update);
        routeSelect.addEventListener('change', update);

        optimizeButton.addEventListener('click', () => {
            const routeIdx = parseInt(routeSelect.value);
            let entries = routeIdx === -1 ? pkData : [pkData[routeIdx]];
            let recommendations = [];
            entries.forEach((entry) => {
                const { dose: optDose, interval: optInterval } = optimizeDosing(entry);
                recommendations.push(`Optimal for ${entry.route_name}: ${optDose} mg every ${optInterval} hours`);
            });
            document.getElementById('dosingRecommendation').innerHTML = recommendations.join('<br>');

            if (routeIdx !== -1) {
                const { dose: optDose, interval: optInterval } = optimizeDosing(pkData[routeIdx]);
                doseInput.value = optDose;
                steadyStateCheck.checked = true;
                intervalInput.value = optInterval;
                update();
            }
        });

        resetButton.addEventListener('click', () => {
            doseInput.value = {{ request.args.get('dose', 100) }};
            steadyStateCheck.checked = false;
            intervalInput.value = 8;
            routeSelect.value = -1;
            document.getElementById('dosingRecommendation').innerHTML = '';
            update();
        });

        update();
    }
    {% endif %}
});
    </script>
</body>
</html>