<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Drug Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <!-- Added custom CSS for validation feedback -->
    <style>
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .invalid-feedback {
            display: none;
            color: #dc3545;
        }
        .is-invalid ~ .invalid-feedback {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Add New Drug Detail</h1>
        <form action="/details/add" method="POST" enctype="multipart/form-data" id="drug-detail-form">
            <!-- Uyarı Mesajı -->
            {% if error_message %}
            <div class="alert alert-danger">
                {{ error_message }}
            </div>
            {% endif %}

            <!-- Active Ingredient -->
            <div class="mb-3">
                <label for="drug_id" class="form-label">Active Ingredient</label>
                <select id="drug_id" name="drug_id" class="form-select" required aria-label="Active Ingredient"></select>
            </div>

            <!-- Salt -->
            <div class="mb-3">
                <label for="salt_id" class="form-label">Salt (Optional)</label>
                <select class="form-select" id="salt_id" name="salt_id" aria-label="Salt">
                    <option value="">No Selection</option>
                    {% for salt in salts %}
                        <option value="{{ salt.id }}">{{ salt.name_en }} ({{ salt.name_tr }})</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Category Selection -->
            <div class="mb-3">
                <label for="categories" class="form-label">Drug Categories</label>
                <select class="form-select" id="categories" name="category_ids[]" multiple aria-label="Drug Categories"></select>
                <div id="selected-categories" class="list-group mt-2"></div>
            </div>
            <!-- Molecular Formula -->
            <div class="mb-3">
                <label for="molecular_formula" class="form-label">Molecular Formula</label>
                <input type="text" class="form-control" id="molecular_formula" name="molecular_formula" aria-label="Molecular Formula">
            </div>

            <!-- Molecular Weight -->
            <div class="mb-3">
                <label for="molecular_weight" class="form-label" data-bs-toggle="tooltip" title="Molecular weight in g/mol">Molecular Weight</label>
                <div class="input-group">
                    <input type="number" step="0.01" class="form-control" id="molecular_weight" name="molecular_weight" placeholder="Enter molecular weight" aria-label="Molecular Weight Value">
                    <select class="form-select" id="molecular_weight_unit_id" name="molecular_weight_unit_id" style="width: auto;" aria-label="Molecular Weight Unit">
                        <option value="">Select Unit</option>
                        {% for unit in units %}
                            <option value="{{ unit.id }}" {% if unit.name == 'g/mol' %}selected{% endif %}>{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Structure (Image) -->
            <div class="mb-3">
                <label for="structure" class="form-label">Structure (Image)</label>
                <input type="file" class="form-control" id="structure" name="structure" accept="image/*" aria-label="Structure Image">
            </div>

            <!-- Synthesis -->
            <div class="mb-3">
                <label for="synthesis" class="form-label" data-bs-toggle="tooltip" title="Details of the drug synthesis process">Synthesis</label>
                <div id="synthesis_editor" style="height: 200px;" aria-label="Synthesis Editor"></div>
                <input type="hidden" id="synthesis" name="synthesis">
            </div>

            <!-- IUPAC Name -->
            <div class="mb-3">
                <label for="iupac_name" class="form-label">IUPAC Name</label>
                <input type="text" class="form-control" id="iupac_name" name="iupac_name" aria-label="IUPAC Name">
            </div>

            <!-- SMILES -->
            <div class="mb-3">
                <label for="smiles" class="form-label">SMILES</label>
                <input type="text" class="form-control" id="smiles" name="smiles" aria-label="SMILES">
            </div>

            <!-- CAS ID, RXCUI, PUBCHEM CID, PUBCHEM SID, INCHI KEY, EC NUMBER, NCI CODE, SNOMED ID -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="cas_id" class="form-label">CAS ID</label>
                    <input type="text" class="form-control" id="cas_id" name="cas_id" aria-label="CAS ID">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="rxcui" class="form-label">RXCUI</label>
                    <input type="text" class="form-control" id="rxcui" name="rxcui" aria-label="RXCUI">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="pubchem_cid" class="form-label">PubChem CID</label>
                    <input type="text" class="form-control" id="pubchem_cid" name="pubchem_cid" aria-label="PubChem CID">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="pubchem_sid" class="form-label">PubChem SID</label>
                    <input type="text" class="form-control" id="pubchem_sid" name="pubchem_sid" aria-label="PubChem SID">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="inchikey" class="form-label">InChIKey</label>
                    <input type="text" class="form-control" id="inchikey" name="inchikey" aria-label="InChIKey">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="ec_number" class="form-label">EC Number</label>
                    <input type="text" class="form-control" id="ec_number" name="ec_number" aria-label="EC Number">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="nci_code" class="form-label">NCI code</label>
                    <input type="text" class="form-control" id="nci_code" name="nci_code" aria-label="NCI Code">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="snomed_id" class="form-label">SNOMED ID</label>
                    <input type="text" class="form-control" id="snomed_id" name="snomed_id" aria-label="SNOMED ID">
                </div>
            </div>

            <!-- Physical Properties -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="boiling_point" class="form-label">Boiling Point</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="boiling_point" name="boiling_point" placeholder="e.g., 100" aria-label="Boiling Point Value">
                        <select class="form-select" id="boiling_point_unit_id" name="boiling_point_unit_id" style="width: auto;" aria-label="Boiling Point Unit">
                            <option value="">Select Unit</option>
                            {% for unit in units %}
                                <option value="{{ unit.id }}" {% if unit.name == '°C' %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="melting_point" class="form-label">Melting Point</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="melting_point" name="melting_point" placeholder="e.g., 50" aria-label="Melting Point Value">
                        <select class="form-select" id="melting_point_unit_id" name="melting_point_unit_id" style="width: auto;" aria-label="Melting Point Unit">
                            <option value="">Select Unit</option>
                            {% for unit in units %}
                                <option value="{{ unit.id }}" {% if unit.name == '°C' %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="density" class="form-label">Density</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="density" name="density" placeholder="e.g., 1.2" aria-label="Density Value">
                        <select class="form-select" id="density_unit_id" name="density_unit_id" style="width: auto;" aria-label="Density Unit">
                            <option value="">Select Unit</option>
                            {% for unit in units %}
                                <option value="{{ unit.id }}" {% if unit.name == 'g/cm³' %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Solubility and Flash Point -->
            <div class="mb-3">
                <label for="solubility" class="form-label">Solubility</label>
                <div class="input-group">
                    <input type="number" step="0.01" class="form-control" id="solubility" name="solubility" placeholder="e.g., 10" aria-label="Solubility Value">
                    <select class="form-select" id="solubility_unit_id" name="solubility_unit_id" style="width: auto;" aria-label="Solubility Unit">
                        <option value="">Select Unit</option>
                        {% for unit in units %}
                            <option value="{{ unit.id }}" {% if unit.name == 'g/L' %}selected{% endif %}>{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="flash_point" class="form-label">Flash Point</label>
                <div class="input-group">
                    <input type="number" step="0.01" class="form-control" id="flash_point" name="flash_point" placeholder="e.g., 75" aria-label="Flash Point Value">
                    <select class="form-select" id="flash_point_unit_id" name="flash_point_unit_id" style="width: auto;" aria-label="Flash Point Unit">
                        <option value="">Select Unit</option>
                        {% for unit in units %}
                            <option value="{{ unit.id }}" {% if unit.name == '°C' %}selected{% endif %}>{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Black Box Warning -->
            <div class="form-group">
                <label for="black_box_warning">Contains Black Box Warning</label>
                <input type="checkbox" id="black_box_warning" name="black_box_warning" aria-label="Black Box Warning Checkbox">
            </div>
            <div id="black_box_details_container" style="display: none;" aria-hidden="true">
                <label for="black_box_details">Black Box Warning Details</label>
                <div id="black_box_details_editor" style="height: 200px;" aria-label="Black Box Warning Details Editor"></div>
                <input type="hidden" id="black_box_details" name="black_box_details">
            </div>

            <!-- Pharmacodynamics -->
            <div class="mb-3">
                <label for="pharmacodynamics" class="form-label" data-bs-toggle="tooltip" title="General pharmacodynamic properties of the drug">General Pharmacodynamics</label>
                <div id="pharmacodynamics_editor" style="height: 200px;" aria-label="Pharmacodynamics Editor"></div>
                <input type="hidden" id="pharmacodynamics" name="pharmacodynamics">
            </div>

            <!-- Pharmacokinetics -->
            <div class="form-group">
                <label for="pharmacokinetics" class="form-label" data-bs-toggle="tooltip" title="ADME properties (absorption, distribution, metabolism, excretion)">General Pharmacokinetics:</label>
                <small class="form-text text-muted">Provide pharmacokinetics data such as absorption, distribution, metabolism, and excretion (ADME) that applies to the entire drug.</small>
                <div id="pharmacokinetics_editor" style="height: 200px;" aria-label="Pharmacokinetics Editor"></div>
                <input type="hidden" id="pharmacokinetics" name="pharmacokinetics">
            </div>

            <!-- Mechanism of Action -->
            <div class="mb-3">
                <label for="mechanism_of_action" class="form-label" data-bs-toggle="tooltip" title="How the drug produces its pharmacological effect">Mechanism of Action</label>
                <div id="mechanism_of_action_editor" style="height: 200px;" aria-label="Mechanism of Action Editor"></div>
                <input type="hidden" id="mechanism_of_action" name="mechanism_of_action">
            </div>

            <!-- Pregnancy Safety -->
            <div class="form-group">
                <label for="pregnancy_safety_id">Pregnancy Safety</label>
                <select class="form-control" id="pregnancy_safety_id" name="pregnancy_safety_id" required aria-label="Pregnancy Safety Category">
                    <option value="">Select a category</option>
                    {% for category in safety_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="pregnancy_details_group" style="display: none;" aria-hidden="true">
                <label for="pregnancy_details">Pregnancy Details</label>
                <div id="pregnancy_details_editor" style="height: 200px;" aria-label="Pregnancy Details Editor"></div>
                <input type="hidden" id="pregnancy_details" name="pregnancy_details">
            </div>

            <!-- Lactation Safety -->
            <div class="form-group">
                <label for="lactation_safety_id">Lactation Safety</label>
                <select class="form-control" id="lactation_safety_id" name="lactation_safety_id" required aria-label="Lactation Safety Category">
                    <option value="">Select a category</option>
                    {% for category in safety_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="lactation_details_group" style="display: none;" aria-hidden="true">
                <label for="lactation_details">Lactation Details</label>
                <div id="lactation_details_editor" style="height: 200px;" aria-label="Lactation Details Editor"></div>
                <input type="hidden" id="lactation_details" name="lactation_details">
            </div>

            <!-- Target Molecules -->
            <div class="form-group">
                <label for="target_molecules">Target Molecules</label>
                <input type="text" id="target-search" class="form-control" placeholder="Search target molecules..." aria-label="Search Target Molecules">
                <div id="target-results" class="dropdown-menu"></div>
                <ul id="selected-targets" class="list-group mt-2"></ul>
                <input type="hidden" id="hidden-target-molecules" name="target_molecules[]">
            </div>

            <!-- Side Effects -->
            <div class="mb-3">
                <label for="side_effects" class="form-label">Side Effects</label>
                <select id="side_effects" name="side_effects[]" class="form-control" multiple aria-label="Side Effects"></select>
            </div>

            <!-- Indications (Diseases) -->
            <div class="mb-3">
                <label for="general_indications" class="form-label">General Indications (Diseases)</label>
                <select id="general_indications" name="indications[]" class="form-select" multiple aria-label="General Indications"></select>
            </div>

            <!-- Approval Status -->
            <div class="mb-3">
                <label class="form-label">Approval Status</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fda_approved" name="fda_approved" aria-label="FDA Approved">
                    <label class="form-check-label" for="fda_approved">FDA Approved</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ema_approved" name="ema_approved" aria-label="EMA Approved">
                    <label class="form-check-label" for="ema_approved">EMA Approved</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="titck_approved" name="titck_approved" aria-label="TITCK Approved">
                    <label class="form-check-label" for="titck_approved">TITCK Approved</label>
                </div>
            </div>

            <!-- Routes of Administration -->
            <div class="mb-3">
                <label for="routes" class="form-label">Routes of Administration</label>
                <select class="form-select" id="routes" name="route_id[]" multiple aria-label="Routes of Administration">
                    {% for route in routes %}
                        <option value="{{ route.id }}">{{ route.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Route-Specific Indications -->
            <div id="route-indications-container">
                <!-- This will be dynamically populated with route-specific indication selectors -->
            </div>

            <!-- Pharmacodynamics ve Pharmacokinetics -->
            <div id="route-effects-container">
                <!-- Bu alan dinamik olarak doldurulacak -->
            </div>

            <!-- References -->
            <div class="mb-3">
                <label for="references" class="form-label" data-bs-toggle="tooltip" title="References or sources for the drug information">References</label>
                <div id="references_editor" style="height: 200px;" aria-label="References Editor"></div>
                <input type="hidden" id="references" name="references">
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Make units available in JavaScript
    window.units = {{ units_json|safe }};

    // Define safetyCategories
    const safetyCategories = {
        {% for category in safety_categories %}
            "{{ category.id }}": "{{ category.name }}",
        {% endfor %}
    };

    // Warn if no safety categories
    if (Object.keys(safetyCategories).length === 0) {
        console.warn('No safety categories available. Pregnancy and lactation dropdowns may not function correctly.');
        $('#pregnancy_details_group').hide();
        $('#lactation_details_group').hide();
    }

    let currentDrugId = null; // Track the current drug ID

    // Metabolite Editor Functions (moved to global scope)
    window.editMetabolites = function(routeId) {
        console.log('editMetabolites called with routeId:', routeId); // Debug log
        const routesDropdown = document.getElementById('routes');
        const routeName = Array.from(routesDropdown.options).find(opt => opt.value === routeId)?.text || 'Route';

        // Create modal HTML with proper ARIA attributes
        const modal = `
            <div class="modal fade" id="metaboliteModal_${routeId}" tabindex="-1" aria-labelledby="metaboliteModalLabel_${routeId}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="metaboliteModalLabel_${routeId}">Edit Metabolites for ${routeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="new_metabolite_${routeId}" class="form-label">Metabolite Name</label>
                                <input type="text" class="form-control" id="new_metabolite_${routeId}" placeholder="Enter metabolite name" aria-label="New Metabolite Name">
                            </div>
                            <div class="mb-3">
                                <label for="parent_metabolite_${routeId}" class="form-label">Parent Metabolite</label>
                                <select class="form-select" id="parent_metabolite_${routeId}" aria-label="Parent Metabolite">
                                    <option value="">None (Top Level)</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addMetabolite('${routeId}')">Add Metabolite</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);

        // Populate parent metabolite dropdown
        const parentSelect = document.getElementById(`parent_metabolite_${routeId}`);
        const currentMetabolites = $(`#metabolites_${routeId}`).select2('data');
        currentMetabolites.forEach(m => {
            const option = new Option(m.text, m.id, false, false);
            parentSelect.appendChild(option);
        });

        // Initialize and show modal
        try {
            const modalEl = document.getElementById(`metaboliteModal_${routeId}`);
            const bsModal = new bootstrap.Modal(modalEl, {
                backdrop: 'static',
                keyboard: false
            });
            bsModal.show();

            // Clean up modal when hidden
            modalEl.addEventListener('hidden.bs.modal', () => {
                modalEl.remove();
            }, { once: true });
        } catch (error) {
            console.error('Error initializing modal:', error);
            alert('Failed to open metabolite editor: ' + error.message);
        }
    };

    window.renderMetaboliteTree = async function(routeId) {
        console.log('renderMetaboliteTree called with routeId:', routeId); // Debug log
        const select = document.getElementById(`metabolites_${routeId}`);
        const diagram = document.getElementById(`metabolite_diagram_${routeId}`);
        if (!select || !diagram) {
            console.error(`Missing elements for route ${routeId}: select=${!!select}, diagram=${!!diagram}`);
            return;
        }

        const selectedIds = $(select).val() || [];
        if (!selectedIds.length) {
            diagram.innerHTML = 'No metabolites selected.';
            return;
        }

        try {
            const drugId = currentDrugId;
            const response = await fetch(`/api/metabolites/full?ids=${encodeURIComponent(selectedIds.join(','))}&drug_id=${drugId || ''}`, {
                credentials: 'include' // Ensure session cookies are sent
            });
            if (!response.ok) {
                throw new Error(`Fetch failed: ${response.status} - ${response.statusText}`);
            }
            const metabolites = await response.json();
            if (!metabolites || !Array.isArray(metabolites)) {
                throw new Error('Invalid response format: expected an array of metabolites');
            }
            diagram.innerHTML = buildTreeHTML(metabolites);
        } catch (error) {
            console.error(`Error rendering tree for route ${routeId}:`, error);
            diagram.innerHTML = `Error loading diagram: ${error.message}`;
        }
    };

    window.buildTreeHTML = function(metabolites, parentId = null, prefix = '') {
        const children = metabolites.filter(m => m.parent_id === parentId);
        if (!children.length) return '';
        let html = '';
        children.forEach(child => {
            html += `<div>${prefix}${child.name}</div>`;
            html += buildTreeHTML(metabolites, child.id, `${prefix}  - `);
        });
        return html;
    };

    window.addMetabolite = async function(routeId) {
        console.log('addMetabolite called with routeId:', routeId); // Debug log
        const name = document.getElementById(`new_metabolite_${routeId}`).value.trim();
        const parentId = document.getElementById(`parent_metabolite_${routeId}`).value || null;
        if (!name) {
            alert('Metabolite name is required.');
            return;
        }

        try {
            const drugId = currentDrugId;
            if (!drugId) {
                throw new Error('No drug selected. Please select an active ingredient.');
            }
            const response = await fetch('/api/metabolites/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // Ensure session cookies are sent
                body: JSON.stringify({ name, parent_id: parentId, drug_id: drugId })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to add metabolite: ${response.status} - ${errorText}`);
            }
            const newMetabolite = await response.json();

            const select = $(`#metabolites_${routeId}`);
            select.append(new Option(newMetabolite.name, newMetabolite.id, true, true));
            select.trigger('change');

            const modalEl = document.getElementById(`metaboliteModal_${routeId}`);
            bootstrap.Modal.getInstance(modalEl).hide();
            modalEl.remove();
        } catch (error) {
            console.error('Error adding metabolite:', error);
            alert(`Error adding metabolite: ${error.message}`);
        }
    };

    $(document).ready(function () {
        // Initialize Quill editors
        const toolbarOptions = [
            ['bold', 'italic', 'underline'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link']
        ];

        const moaQuill = new Quill('#mechanism_of_action_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const pdQuill = new Quill('#pharmacodynamics_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const referencesQuill = new Quill('#references_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const pkQuill = new Quill('#pharmacokinetics_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const synthesisQuill = new Quill('#synthesis_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const pregnancyDetailsQuill = new Quill('#pregnancy_details_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const lactationDetailsQuill = new Quill('#lactation_details_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        const blackBoxDetailsQuill = new Quill('#black_box_details_editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions }
        });

        // Sync Quill content to hidden inputs on form submit
        $('form').on('submit', function (e) {
            $('#mechanism_of_action').val(moaQuill.root.innerHTML);
            $('#pharmacodynamics').val(pdQuill.root.innerHTML);
            $('#pharmacokinetics').val(pkQuill.root.innerHTML);
            $('#synthesis').val(synthesisQuill.root.innerHTML);
            $('#references').val(referencesQuill.root.innerHTML);
            $('#pregnancy_details').val(pregnancyDetailsQuill.root.innerHTML);
            $('#lactation_details').val(lactationDetailsQuill.root.innerHTML);
            $('#black_box_details').val(blackBoxDetailsQuill.root.innerHTML);

            // Client-side validation for pregnancy/lactation
            const pregnancySafetyId = $('#pregnancy_safety_id').val();
            const lactationSafetyId = $('#lactation_safety_id').val();
            const pregnancySafetyName = safetyCategories[pregnancySafetyId] || '';
            const lactationSafetyName = safetyCategories[lactationSafetyId] || '';
            const pregnancyDetails = pregnancyDetailsQuill.root.innerHTML.trim();
            const lactationDetails = lactationDetailsQuill.root.innerHTML.trim();

            if (pregnancySafetyId && (pregnancySafetyName === 'Caution' || pregnancySafetyName === 'Contraindicated') && pregnancyDetails === '<p><br></p>') {
                e.preventDefault();
                alert('Please provide details for Pregnancy Safety (Caution or Contraindicated).');
                $('#pregnancy_safety_id').addClass('is-invalid');
                return;
            }
            if (lactationSafetyId && (lactationSafetyName === 'Caution' || lactationSafetyName === 'Contraindicated') && lactationDetails === '<p><br></p>') {
                e.preventDefault();
                alert('Please provide details for Lactation Safety (Caution or Contraindicated).');
                $('#lactation_safety_id').addClass('is-invalid');
                return;
            }

            // Validate route-specific ranges
            let valid = true;
            Array.from(routesDropdown.selectedOptions).forEach(option => {
                const routeId = option.value;
                ['absorption_rate', 'vod_rate', 'half_life', 'clearance_rate', 'tmax', 'cmax', 'therapeutic_range'].forEach(field => {
                    const input = document.getElementById(`${field}_${routeId}`);
                    const unitSelect = document.getElementById(`${field}_unit_id_${routeId}`);
                    if (input && input.value && !unitSelect?.value) {
                        unitSelect.classList.add('is-invalid');
                        valid = false;
                    }
                    if (input && !validateRangeInput(input)) {
                        valid = false;
                    }
                });
            });
            if (!valid) {
                e.preventDefault();
                alert('Please correct invalid range inputs or select units for route-specific fields.');
            }
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Validate numeric inputs
        ['molecular_weight', 'boiling_point', 'melting_point', 'density', 'solubility', 'flash_point'].forEach(id => {
            $(`#${id}`).on('input', function () {
                if (this.value < 0) {
                    this.value = '';
                    alert(`${this.previousElementSibling.textContent} cannot be negative!`);
                }
            });
        });

        // Initialize Select2 for pregnancy/lactation dropdowns
        $('#pregnancy_safety_id').select2({
            placeholder: "Select a category",
            allowClear: true,
            width: '100%'
        }).on('change', function () {
            console.log('Pregnancy Safety changed:', this.value);
            $(this).removeClass('is-invalid');
            togglePregnancyDetails();
        });

        $('#lactation_safety_id').select2({
            placeholder: "Select a category",
            allowClear: true,
            width: '100%'
        }).on('change', function () {
            console.log('Lactation Safety changed:', this.value);
            $(this).removeClass('is-invalid');
            toggleLactationDetails();
        });

        // Initialize drug_id Select2
        $('#drug_id').select2({
            placeholder: "Search by English, Turkish, or Alternative Name...",
            ajax: {
                url: "/api/active_ingredients",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term,
                        limit: 10,
                        page: params.page || 1
                    };
                },
                processResults: function (data) {
                    console.log("Drug API Response:", data);
                    if (data.error) {
                        console.error("Server error:", data.error);
                        return { results: [] };
                    }
                    if (!data.results || !Array.isArray(data.results)) {
                        console.error("Invalid API response format:", data);
                        return { results: [] };
                    }
                    return {
                        results: data.results,
                        pagination: { more: data.pagination?.more || false }
                    };
                },
                error: function (xhr, status, error) {
                    console.error("Drug AJAX Error:", status, error, xhr.responseText);
                    return { results: [] };
                }
            },
            minimumInputLength: 1,
            allowClear: true,
            width: '100%'
        }).on('change', function () {
            currentDrugId = $(this).val();
            console.log("Drug ID changed to:", currentDrugId);
            document.getElementById('routes').dispatchEvent(new Event('change'));
        });
        
        // Category Search
        $('#categories').select2({
            placeholder: "Search for categories...",
            ajax: {
                url: "/api/categories",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term,
                        limit: 10,
                        page: params.page || 1
                    };
                },
                processResults: function (data) {
                    console.log("Categories API Response:", data);
                    if (data.error || !data.results || !Array.isArray(data.results)) {
                        console.error("Invalid categories API response:", data);
                        return { results: [] };
                    }
                    return {
                        results: data.results,
                        pagination: { more: data.pagination?.more || false }
                    };
                },
                error: function (xhr, status, error) {
                    console.error("Categories AJAX Error:", status, error, xhr.responseText);
                    return { results: [] };
                }
            },
            minimumInputLength: 1,
            allowClear: true,
            width: '100%'
        }).on('change', function () {
            const selectedCategories = $(this).select2('data');
            const selectedCategoriesList = document.getElementById('selected-categories');
            selectedCategoriesList.innerHTML = '';
            selectedCategories.forEach(category => {
                const listItem = document.createElement('div');
                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                listItem.textContent = category.text;
                selectedCategoriesList.appendChild(listItem);
            });
        });

        // Initialize side_effects Select2
        $('#side_effects').select2({
            placeholder: 'Search for side effects',
            minimumInputLength: 2,
            ajax: {
                url: '/api/side_effects',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        search: params.term,
                        limit: 10
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.map(function (item) {
                            return { id: item.id, text: item.text };
                        })
                    };
                },
                cache: true
            },
            width: '100%'
        });

        // Initialize general_indications Select2
        $('#general_indications').select2({
            placeholder: "Search for Indications (Diseases)...",
            ajax: {
                url: "/indications/search",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        search: params.term,
                        limit: 10,
                        page: params.page || 1,
                        drug_id: currentDrugId
                    };
                },
                processResults: function (data) {
                    console.log("Indications API Response:", data);
                    return {
                        results: data.results,
                        pagination: { more: data.has_next }
                    };
                },
                error: function (xhr, status, error) {
                    console.error("Indications AJAX Error:", status, error, xhr.responseText);
                    return { results: [] };
                }
            },
            minimumInputLength: 2,
            allowClear: true,
            multiple: true,
            width: '100%'
        }).on('select2:unselect', function (e) {
            console.log("Removed Indication:", e.params.data);
        });

        // Initialize target molecules search
        const searchInput = document.getElementById("target-search");
        const resultsDropdown = document.getElementById("target-results");
        const selectedTargets = document.getElementById("selected-targets");
        const hiddenTargetInput = document.getElementById("hidden-target-molecules");
        const selectedTargetIds = [];

        searchInput.addEventListener("input", async function () {
            const query = searchInput.value;
            if (query.length < 2) {
                resultsDropdown.style.display = "none";
                return;
            }

            try {
                const response = await fetch(`/api/targets?query=${encodeURIComponent(query)}&drug_id=${currentDrugId || ''}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`Fetch failed: ${response.status} - ${response.statusText}`);
                }
                const targets = await response.json();

                resultsDropdown.innerHTML = "";
                resultsDropdown.style.display = "block";

                targets.forEach(target => {
                    const item = document.createElement("div");
                    item.classList.add("dropdown-item");
                    item.textContent = target.name_en;

                    item.addEventListener("click", function () {
                        if (!selectedTargetIds.includes(target.id)) {
                            selectedTargetIds.push(target.id);
                            const selectedItem = document.createElement("li");
                            selectedItem.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
                            selectedItem.textContent = target.name_en;

                            const removeBtn = document.createElement("button");
                            removeBtn.classList.add("btn", "btn-danger", "btn-sm");
                            removeBtn.textContent = "Remove";

                            removeBtn.addEventListener("click", function () {
                                const index = selectedTargetIds.indexOf(target.id);
                                if (index > -1) selectedTargetIds.splice(index, 1);
                                hiddenTargetInput.value = selectedTargetIds.join(',');
                                selectedItem.remove();
                            });

                            selectedItem.appendChild(removeBtn);
                            selectedTargets.appendChild(selectedItem);
                        }

                        hiddenTargetInput.value = selectedTargetIds.join(',');
                        searchInput.value = "";
                        resultsDropdown.style.display = "none";
                    });

                    resultsDropdown.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching targets:', error);
                resultsDropdown.innerHTML = '<div class="dropdown-item text-danger">Error loading targets</div>';
            }
        });

        // Toggle functions for pregnancy/lactation details
        function togglePregnancyDetails() {
            const pregnancySafetyId = document.getElementById('pregnancy_safety_id').value;
            const pregnancyDetailsGroup = document.getElementById('pregnancy_details_group');
            const pregnancySafetyName = safetyCategories[pregnancySafetyId] || '';
            if (pregnancySafetyName === 'Caution' || pregnancySafetyName === 'Contraindicated') {
                pregnancyDetailsGroup.style.display = 'block';
                pregnancyDetailsGroup.setAttribute('aria-hidden', 'false');
            } else {
                pregnancyDetailsGroup.style.display = 'none';
                pregnancyDetailsGroup.setAttribute('aria-hidden', 'true');
                pregnancyDetailsQuill.root.innerHTML = '';
                $('#pregnancy_details').val('');
            }
        }

        function toggleLactationDetails() {
            const lactationSafetyId = document.getElementById('lactation_safety_id').value;
            const lactationDetailsGroup = document.getElementById('lactation_details_group');
            const lactationSafetyName = safetyCategories[lactationSafetyId] || '';
            if (lactationSafetyName === 'Caution' || lactationSafetyName === 'Contraindicated') {
                lactationDetailsGroup.style.display = 'block';
                lactationDetailsGroup.setAttribute('aria-hidden', 'false');
            } else {
                lactationDetailsGroup.style.display = 'none';
                lactationDetailsGroup.setAttribute('aria-hidden', 'true');
                lactationDetailsQuill.root.innerHTML = '';
                $('#lactation_details').val('');
            }
        }

        // Bind change event to Black Box Warning checkbox
        $('#black_box_warning').on('change', function () {
            console.log('Black Box Warning checkbox changed:', this.checked);
            toggleBlackBoxDetails();
        });

        function toggleBlackBoxDetails() {
            const checkbox = document.getElementById('black_box_warning');
            const detailsContainer = document.getElementById('black_box_details_container');
            if (checkbox.checked) {
                detailsContainer.style.display = 'block';
                detailsContainer.setAttribute('aria-hidden', 'false');
            } else {
                detailsContainer.style.display = 'none';
                detailsContainer.setAttribute('aria-hidden', 'true');
                blackBoxDetailsQuill.root.innerHTML = '';
                $('#black_box_details').val('');
            }
        }

        // Routes and route-specific indications
        const routesDropdown = document.getElementById('routes');
        const effectsContainer = document.getElementById('route-effects-container');
        const indicationsContainer = document.getElementById('route-indications-container');

        // Validate range inputs
        function validateRangeInput(input) {
            const value = input.value.trim().replace('–', '-');
            input.value = value; // Update the input value
            if (!value) return true;
            if (value.includes('-')) {
                const [min, max] = value.split('-').map(v => parseFloat(v.trim()));
                if (isNaN(min) || isNaN(max) || min > max) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (isNaN(parseFloat(value))) {
                input.classList.add('is-invalid');
                return false;
            }
            input.classList.remove('is-invalid');
            return true;
        }

        async function fetchExistingRoutes(drugId) {
            try {
                const response = await fetch(`/api/drug_routes?drug_id=${drugId}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn("No existing routes found for drug_id:", drugId);
                        return {};
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const routes = await response.json();
                return routes.reduce((acc, route) => {
                    acc[route.route_id] = route;
                    return acc;
                }, {});
            } catch (error) {
                console.error("Error fetching existing routes:", error);
                return {};
            }
        }

        routesDropdown.addEventListener('change', async () => {
            if (!currentDrugId) {
                effectsContainer.innerHTML = '<p>Please select an active ingredient first.</p>';
                indicationsContainer.innerHTML = '';
                return;
            }

            effectsContainer.innerHTML = '<p>Loading...</p>';
            indicationsContainer.innerHTML = '<p>Loading...</p>';
            const existingRoutes = await fetchExistingRoutes(currentDrugId);

            effectsContainer.innerHTML = '';
            indicationsContainer.innerHTML = '';

            Array.from(routesDropdown.selectedOptions).forEach(option => {
                const routeId = option.value;
                const routeName = option.textContent;

                // Route-specific effects
                const effectsDiv = document.createElement('div');
                effectsDiv.classList.add('mb-3');
                effectsDiv.innerHTML = `
                    <h5 class="mt-3">${routeName}</h5>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="absorption_rate_${routeId}" class="form-label">Absorption Rate</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="absorption_rate_${routeId}" name="absorption_rate_${routeId}" placeholder="e.g., 10-15 or 12" aria-label="Absorption Rate for ${routeName}">
                                <select class="form-select" id="absorption_rate_unit_id_${routeId}" name="absorption_rate_unit_id_${routeId}" style="width: auto;" aria-label="Absorption Rate Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === '%/h' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="vod_rate_${routeId}" class="form-label">Volume of Distribution</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vod_rate_${routeId}" name="vod_rate_${routeId}" placeholder="e.g., 20-30 or 25" aria-label="Volume of Distribution for ${routeName}">
                                <select class="form-select" id="vod_rate_unit_id_${routeId}" name="vod_rate_unit_id_${routeId}" style="width: auto;" aria-label="Volume of Distribution Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'L' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="protein_binding_${routeId}" class="form-label">Protein Binding (%)</label>
                            <input type="text" class="form-control" id="protein_binding_${routeId}" name="protein_binding_${routeId}" placeholder="e.g., 70-80 or 75" aria-label="Protein Binding for ${routeName}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="half_life_${routeId}" class="form-label">Half-Life</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="half_life_${routeId}" name="half_life_${routeId}" placeholder="e.g., 1-2 or 1.5" aria-label="Half-Life for ${routeName}">
                                <select class="form-select" id="half_life_unit_id_${routeId}" name="half_life_unit_id_${routeId}" style="width: auto;" aria-label="Half-Life Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'hours' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="clearance_rate_${routeId}" class="form-label">Clearance Rate</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="clearance_rate_${routeId}" name="clearance_rate_${routeId}" placeholder="e.g., 50-60 or 55" aria-label="Clearance Rate for ${routeName}">
                                <select class="form-select" id="clearance_rate_unit_id_${routeId}" name="clearance_rate_unit_id_${routeId}" style="width: auto;" aria-label="Clearance Rate Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'mL/min' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="bioavailability_${routeId}" class="form-label">Bioavailability (%)</label>
                            <input type="text" class="form-control" id="bioavailability_${routeId}" name="bioavailability_${routeId}" placeholder="e.g., 50-70 or 60" aria-label="Bioavailability for ${routeName}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="tmax_${routeId}" class="form-label">Tmax</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="tmax_${routeId}" name="tmax_${routeId}" placeholder="e.g., 1-2 or 1.5" aria-label="Tmax for ${routeName}">
                                <select class="form-select" id="tmax_unit_id_${routeId}" name="tmax_unit_id_${routeId}" style="width: auto;" aria-label="Tmax Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'hours' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="cmax_${routeId}" class="form-label">Cmax</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="cmax_${routeId}" name="cmax_${routeId}" placeholder="e.g., 10-20 or 15" aria-label="Cmax for ${routeName}">
                                <select class="form-select" id="cmax_unit_id_${routeId}" name="cmax_unit_id_${routeId}" style="width: auto;" aria-label="Cmax Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'mg/L' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="invalid-feedback">Please select a unit if a value is provided.</div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="therapeutic_range_${routeId}" class="form-label">Therapeutic Range</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="therapeutic_range_${routeId}" name="therapeutic_range_${routeId}" placeholder="e.g., 10-30" aria-label="Therapeutic Range for ${routeName}">
                                <select class="form-select" id="therapeutic_unit_id_${routeId}" name="therapeutic_unit_id_${routeId}" style="width: auto;" aria-label="Therapeutic Range Unit for ${routeName}">
                                    <option value="">Select Unit</option>
                                    ${window.units.map(unit => `<option value="${unit.id}" ${unit.name === 'mg/L' ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                </select>
                            </div>
                            <div id="therapeutic_range_error_${routeId}" class="invalid-feedback"></div>
                        </div>
                    </div>
                    <label for="route_pharmacodynamics_${routeId}" class="form-label">Pharmacodynamics</label>
                    <textarea class="form-control mb-2" id="route_pharmacodynamics_${routeId}" name="route_pharmacodynamics_${routeId}" rows="2" placeholder="Additional PD details..." aria-label="Pharmacodynamics for ${routeName}"></textarea>
                    <label for="route_pharmacokinetics_${routeId}" class="form-label">Other Pharmacokinetics</label>
                    <textarea class="form-control mb-2" id="route_pharmacokinetics_${routeId}" name="route_pharmacokinetics_${routeId}" rows="2" placeholder="Additional PK details..." aria-label="Pharmacokinetics for ${routeName}"></textarea>
                    <div class="mb-2">
                        <label for="metabolism_select_${routeId}_organs" class="form-label">Metabolism Organs</label>
                        <select class="form-select" id="metabolism_organs_${routeId}" name="metabolism_organs_${routeId}[]" multiple aria-label="Metabolism Organs for ${routeName}"></select>
                    </div>
                    <div class="mb-2">
                        <label for="metabolism_select_${routeId}_enzymes" class="form-label">Metabolism Enzymes</label>
                        <select class="form-select" id="metabolism_enzymes_${routeId}" name="metabolism_enzymes_${routeId}[]" multiple aria-label="Metabolism Enzymes for ${routeName}"></select>
                    </div>
                    <div class="mb-2">
                        <label for="metabolites_${routeId}" class="form-label">Metabolites</label>
                        <select class="form-select" id="metabolites_${routeId}" name="metabolites_${routeId}[]" multiple aria-label="Metabolites for ${routeName}"></select>
                        <div id="metabolite_diagram_${routeId}" class="border p-2 mt-2" style="min-height: 100px;"></div>
                        <button type="button" class="btn btn-outline-secondary mt-2" onclick="editMetabolites('${routeId}')">Edit Metabolites</button>
                    </div>
                `;
                effectsContainer.appendChild(effectsDiv);

                // Route-specific indications
                const indicationSection = document.createElement('div');
                indicationSection.classList.add('mb-3');
                indicationSection.innerHTML = `
                    <h5>${routeName}</h5>
                    <label for="route_indications_${routeId}" class="form-label">Indications for ${routeName}</label>
                    <select class="form-select route-indications" id="route_indications_${routeId}" name="route_indications_${routeId}[]" multiple aria-label="Indications for ${routeName}"></select>
                `;
                indicationsContainer.appendChild(indicationSection);

                // Initialize Select2 for metabolism dropdowns
                $(`#metabolism_organs_${routeId}`).select2({
                    placeholder: "Select organs for this drug...",
                    ajax: {
                        url: "/api/metabolism/organs",
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ q: params.term, drug_id: currentDrugId }),
                        processResults: data => ({ results: data.results })
                    },
                    minimumInputLength: 1,
                    allowClear: true,
                    width: '100%'
                });

                $(`#metabolism_enzymes_${routeId}`).select2({
                    placeholder: "Select enzymes for this drug...",
                    ajax: {
                        url: "/api/metabolism/enzymes",
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ q: params.term, drug_id: currentDrugId }),
                        processResults: data => ({ results: data.results })
                    },
                    minimumInputLength: 1,
                    allowClear: true,
                    width: '100%'
                });

                $(`#metabolites_${routeId}`).select2({
                    placeholder: "Select metabolites for this drug...",
                    ajax: {
                        url: "/api/metabolites",
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ q: params.term, drug_id: currentDrugId }),
                        processResults: data => ({ results: data.results })
                    },
                    minimumInputLength: 1,
                    allowClear: true,
                    width: '100%'
                }).on('change', () => window.renderMetaboliteTree(routeId));

                // Initialize Select2 for route-specific indications
                $(`#route_indications_${routeId}`).select2({
                    placeholder: `Search indications for ${routeName}...`,
                    ajax: {
                        url: `/indications/search`,
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            search: params.term,
                            limit: 10,
                            page: params.page || 1,
                            drug_id: currentDrugId
                        }),
                        processResults: data => ({
                            results: data.results,
                            pagination: { more: data.has_next }
                        }),
                        error: function (xhr, status, error) {
                            console.error(`Route Indications AJAX Error for ${routeId}:`, status, error, xhr.responseText);
                            return { results: [] };
                        }
                    },
                    minimumInputLength: 2,
                    allowClear: true,
                    width: '100%'
                });

                // Add validation for route-specific fields
                ['absorption_rate', 'vod_rate', 'half_life', 'clearance_rate', 'tmax', 'cmax', 'therapeutic_range'].forEach(field => {
                    const input = document.getElementById(`${field}_${routeId}`);
                    const unitSelect = document.getElementById(`${field}_unit_id_${routeId}`);
                    input?.addEventListener('input', () => {
                        validateRangeInput(input);
                        if (input.value && !unitSelect.value) {
                            unitSelect.classList.add('is-invalid');
                        } else {
                            unitSelect.classList.remove('is-invalid');
                        }
                    });
                    unitSelect?.addEventListener('change', () => {
                        if (unitSelect.value || !input.value) {
                            unitSelect.classList.remove('is-invalid');
                        }
                    });
                });
            });
            console.log("Selected Routes:", Array.from(routesDropdown.selectedOptions).map(opt => opt.value));
        });
    });
</script>
</body>
</html>