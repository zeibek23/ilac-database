{% extends "base.html" %}
{% block title %}Receptor-Ligand Interaction Simulator - Drugly{% endblock %}
{% block extra_css %}
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #1f2937;
        min-height: 100vh;
        padding: 1rem;
    }
    .container {
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        padding: 2.5rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>');
        opacity: 0.3;
    }
    h1 {
        font-size: 2.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 1;
    }
    .header p {
        font-size: 1.125rem;
        opacity: 0.95;
        position: relative;
        z-index: 1;
    }
    .content-wrapper {
        padding: 2rem;
    }
    .form-section {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        padding: 2rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        border: 2px solid #e5e7eb;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .form-section h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    .form-group {
        display: flex;
        flex-direction: column;
    }
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .form-group label i {
        color: #3b82f6;
    }
    .form-control {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.3s;
        background: white;
    }
    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    .form-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.375rem;
    }
    .btn {
        padding: 0.875rem 2rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
    }
    .btn-primary:active:not(:disabled) {
        transform: translateY(0);
    }
    .btn-primary:disabled {
        background: #93c5fd;
        cursor: not-allowed;
        box-shadow: none;
        opacity: 0.7;
    }
    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
    }
    .btn-secondary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
    }
    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    .btn-info {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
    }
    .btn-info:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
    }
    .btn-center {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
    .visualization-section {
        margin-bottom: 2rem;
    }
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #e5e7eb;
    }
    .section-header h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .section-header i {
        font-size: 1.5rem;
        color: #3b82f6;
    }
    .visualization-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: center;
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 0.5rem;
        border: 2px solid #e5e7eb;
    }
    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 0.5rem;
        border: 2px solid #e5e7eb;
        transition: all 0.3s;
    }
    .control-group:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }
    .control-group input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
        accent-color: #3b82f6;
    }
    .control-group label {
        cursor: pointer;
        font-weight: 500;
        color: #374151;
        user-select: none;
        margin: 0;
    }
    #viewer {
        width: 100%;
        height: 650px;
        border: 3px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        position: relative;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        overflow: hidden;
    }
    .viewer-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 100;
        display: none;
    }
    .viewer-overlay h4 {
        font-size: 0.875rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 0.5rem;
    }
    .viewer-overlay p {
        font-size: 0.75rem;
        color: #6b7280;
        margin: 0;
    }
    .data-table-section {
        margin-bottom: 2rem;
    }
    .table-wrapper {
        overflow-x: auto;
        border-radius: 0.75rem;
        border: 2px solid #e5e7eb;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    table#interaction-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    table#interaction-table th {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }
    table#interaction-table td {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    table#interaction-table tbody tr {
        transition: all 0.3s;
        cursor: pointer;
    }
    table#interaction-table tbody tr:hover:not(.empty-state) {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%);
        transform: scale(1.005);
    }
    table#interaction-table tbody tr:last-child td {
        border-bottom: none;
    }
    .error-message, .success-message, .info-message {
        display: none;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #b91c1c;
        border-left: 4px solid #dc2626;
    }
    .success-message {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-left: 4px solid #10b981;
    }
    .info-message {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border-left: 4px solid #3b82f6;
    }
    .error-message i, .success-message i, .info-message i {
        font-size: 1.25rem;
    }
    #loading {
        display: none;
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-radius: 0.75rem;
        margin: 1.5rem 0;
        border: 2px solid #bfdbfe;
    }
    #loading p {
        font-size: 1.125rem;
        color: #1e40af;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-weight: 600;
    }
    .spinner {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .footer {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        color: #6b7280;
        border-top: 2px solid #e5e7eb;
    }
    .footer a {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s;
    }
    .footer a:hover {
        color: #2563eb;
        text-decoration: underline;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 2px solid #bfdbfe;
        text-align: center;
        transition: all 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }
    .stat-card h4 {
        font-size: 0.875rem;
        color: #1e40af;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .stat-card p {
        font-size: 1.75rem;
        color: #1f2937;
        font-weight: 700;
        margin: 0;
    }
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }
    .empty-state i {
        font-size: 4rem;
        color: #d1d5db;
        margin-bottom: 1rem;
    }
    .empty-state h4 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    .badge {
        display: inline-block;
        padding: 0.35rem 0.85rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    .badge-primary {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border: 1px solid #93c5fd;
    }
    .badge-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border: 1px solid #6ee7b7;
    }
    .badge-warning {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        border: 1px solid #fcd34d;
    }
    .badge-info {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        color: #075985;
        border: 1px solid #7dd3fc;
    }
    .select2-container--default .select2-selection--single {
        height: 46px !important;
        border: 2px solid #d1d5db !important;
        border-radius: 0.5rem !important;
        transition: all 0.3s;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 42px !important;
        padding-left: 1rem !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 42px !important;
    }
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
    }
    .quick-help {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        border: 2px solid #fcd34d;
    }
    .quick-help h4 {
        font-size: 1rem;
        font-weight: 700;
        color: #92400e;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .quick-help p {
        font-size: 0.875rem;
        color: #78350f;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-atom"></i> Receptor-Ligand Interaction Simulator</h1>
            <p>Explore and visualize human receptor-ligand interactions with advanced 3D molecular visualization</p>
        </div>

        <div class="content-wrapper">
            <!-- Messages -->
            <div id="error-message" class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>
            <div id="success-message" class="success-message">
                <i class="fas fa-check-circle"></i>
                <span></span>
            </div>
            <div id="info-message" class="info-message">
                <i class="fas fa-info-circle"></i>
                <span></span>
            </div>

            <!-- Quick Help -->
            <div class="quick-help">
                <h4><i class="fas fa-lightbulb"></i> Quick Guide</h4>
                <p>1. Select an active ingredient (ligand) from the dropdown. 2. Choose a receptor target. 3. Click "Simulate Interaction" to visualize the molecular docking in 3D.</p>
            </div>

            <!-- Form Section -->
            <div class="form-section">
                <h3><i class="fas fa-sliders-h"></i> Configuration</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="ligand">
                            <i class="fas fa-flask"></i> Active Ingredient (Ligand)
                        </label>
                        <select id="ligand" class="form-control">
                            <option value="">Search for a ligand...</option>
                        </select>
                        <small class="form-text">Search by drug name (e.g., Amlodipine, Aspirin, Ibuprofen)</small>
                    </div>
                    <div class="form-group">
                        <label for="receptor">
                            <i class="fas fa-dna"></i> Receptor Target
                        </label>
                        <select id="receptor" class="form-control">
                            <option value="">Search for a receptor...</option>
                        </select>
                        <small class="form-text">Search by receptor name or gene (e.g., Dopamine, Calcium channel)</small>
                    </div>
                </div>
                <div class="btn-center">
                    <button id="simulate-btn" class="btn btn-primary">
                        <i class="fas fa-play"></i> Simulate Interaction
                    </button>
                    <button id="clear-btn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-redo"></i> Clear & Reset
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading">
                <p><i class="fas fa-spinner spinner"></i> Processing molecular data and rendering 3D structure...</p>
            </div>

            <!-- Statistics -->
            <div id="stats-section" class="stats-grid" style="display: none;">
                <div class="stat-card">
                    <h4><i class="fas fa-magnet"></i> Affinity</h4>
                    <p id="stat-affinity">-</p>
                </div>
                <div class="stat-card">
                    <h4><i class="fas fa-ruler"></i> Parameter</h4>
                    <p id="stat-parameter">-</p>
                </div>
                <div class="stat-card">
                    <h4><i class="fas fa-link"></i> Type</h4>
                    <p id="stat-type">-</p>
                </div>
                <div class="stat-card">
                    <h4><i class="fas fa-cogs"></i> Mechanism</h4>
                    <p id="stat-mechanism">-</p>
                </div>
            </div>

            <!-- Visualization Section -->
            <div class="visualization-section">
                <div class="section-header">
                    <h3><i class="fas fa-cube"></i> 3D Molecular Visualization</h3>
                </div>
                <div class="visualization-controls">
                    <div class="control-group">
                        <input type="checkbox" id="toggle-surface" checked />
                        <label for="toggle-surface">
                            <i class="fas fa-water"></i> Surface
                        </label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-cartoon" checked />
                        <label for="toggle-cartoon">
                            <i class="fas fa-ribbon"></i> Cartoon
                        </label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-ligand" checked />
                        <label for="toggle-ligand">
                            <i class="fas fa-circle"></i> Ligand
                        </label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-labels" checked />
                        <label for="toggle-labels">
                            <i class="fas fa-tag"></i> Labels
                        </label>
                    </div>
                    <button id="zoom-in-btn" class="btn btn-secondary">
                        <i class="fas fa-search-plus"></i> Zoom In
                    </button>
                    <button id="zoom-out-btn" class="btn btn-secondary">
                        <i class="fas fa-search-minus"></i> Zoom Out
                    </button>
                    <button id="reset-view-btn" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Reset View
                    </button>
                    <button id="fullscreen-btn" class="btn btn-info">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                    <button id="export-btn" class="btn btn-success">
                        <i class="fas fa-download"></i> Export PNG
                    </button>
                </div>
                <div id="viewer">
                    <div class="viewer-overlay" id="viewer-info">
                        <h4>Viewer Controls</h4>
                        <p><strong>Rotate:</strong> Left-click + drag</p>
                        <p><strong>Zoom:</strong> Scroll wheel</p>
                        <p><strong>Pan:</strong> Right-click + drag</p>
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="data-table-section">
                <div class="section-header">
                    <h3><i class="fas fa-table"></i> Interaction Details</h3>
                </div>
                <div class="table-wrapper">
                    <table id="interaction-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-flask"></i> Ligand</th>
                                <th><i class="fas fa-dna"></i> Receptor</th>
                                <th><i class="fas fa-magnet"></i> Affinity</th>
                                <th><i class="fas fa-ruler"></i> Parameter</th>
                                <th><i class="fas fa-link"></i> Type</th>
                                <th><i class="fas fa-cogs"></i> Mechanism</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="empty-state">
                                <td colspan="6">
                                    <i class="fas fa-search"></i>
                                    <h4>No Data Yet</h4>
                                    <p>Select a ligand and receptor, then click "Simulate Interaction" to view molecular docking results</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><i class="fas fa-info-circle"></i> All data shown is for human (Homo sapiens) receptors only | Powered by 3Dmol.js & Drugly.AI | <a href="/contact">Contact Support</a></p>
        </div>
    </div>
</body>
{% endblock %}

{% block extra_js %}
<script>
    let viewer;
    let receptorModel;
    let ligandModel;
    let bindingSiteSphere;
    let currentView;
    let currentLabels = [];

    function computeModelCenter(glModel) {
        const atoms = glModel.selectedAtoms({});
        if (atoms.length === 0) return { x: 0, y: 0, z: 0 };
        let cx = 0, cy = 0, cz = 0;
        for (const atom of atoms) {
            cx += atom.x;
            cy += atom.y;
            cz += atom.z;
        }
        return { x: cx / atoms.length, y: cy / atoms.length, z: cz / atoms.length };
    }

    function translateModel(glModel, dx, dy, dz) {
        const atoms = glModel.selectedAtoms({});
        atoms.forEach(atom => {
            atom.x += dx;
            atom.y += dy;
            atom.z += dz;
        });
    }

    function showMessage(type, message) {
        $(`#${type}-message`).find('span').text(message);
        $(`#${type}-message`).fadeIn();
        setTimeout(() => $(`#${type}-message`).fadeOut(), type === 'error' ? 6000 : 4000);
    }

    function showError(message) {
        showMessage('error', message);
    }

    function showSuccess(message) {
        showMessage('success', message);
    }

    function showInfo(message) {
        showMessage('info', message);
    }

    function updateStats(data) {
        $('#stat-affinity').text(data.affinity || 'N/A');
        $('#stat-parameter').text(data.affinity_parameter || 'N/A');
        $('#stat-type').text(data.interaction_type || 'N/A');
        const mechanism = data.mechanism || 'N/A';
        $('#stat-mechanism').text(mechanism.length > 30 ? mechanism.substring(0, 30) + '...' : mechanism);
        $('#stats-section').fadeIn();
    }

    function initViewer() {
        if (!viewer) {
            viewer = $3Dmol.createViewer("viewer", { 
                backgroundColor: "white",
                antialias: true
            });
            $('#viewer-info').delay(3000).fadeIn();
            setTimeout(() => $('#viewer-info').fadeOut(), 8000);
        }
    }

    function updateReceptorStyle() {
        if (!receptorModel) return;
        const receptorModelIndex = receptorModel.id;
        const showSurface = $('#toggle-surface').is(':checked');
        const showCartoon = $('#toggle-cartoon').is(':checked');
        
        let style = {};
        if (showCartoon) {
            style.cartoon = { color: "spectrum" };
        }
        if (showSurface) {
            style.surface = { opacity: 0.65, color: "lightblue" };
        }
        
        viewer.setStyle({ model: receptorModelIndex }, style);
        viewer.render();
    }

    function toggleLabels() {
        const showLabels = $('#toggle-labels').is(':checked');
        viewer.removeAllLabels();
        if (showLabels && currentLabels.length > 0) {
            currentLabels.forEach(label => {
                viewer.addLabel(label.text, label.options);
            });
        }
        viewer.render();
    }

    $(document).ready(function () {
        initViewer();

        // Initialize Select2
        $('#ligand').select2({
            placeholder: "Search for active ingredients...",
            ajax: {
                url: '/api/active_ingredients',
                dataType: 'json',
                delay: 250,
                data: params => ({
                    q: params.term,
                    page: params.page || 1
                }),
                processResults: data => ({
                    results: data.results.map(item => ({ id: item.id, text: item.text })),
                    pagination: { more: data.has_next }
                }),
                cache: true
            },
            minimumInputLength: 2,
            width: '100%'
        });

        $('#receptor').select2({
            placeholder: "Search for receptors...",
            ajax: {
                url: '/api/receptors',
                dataType: 'json',
                delay: 250,
                data: params => ({
                    search: params.term,
                    page: params.page || 1
                }),
                processResults: data => ({
                    results: data.results.map(item => ({ id: item.id, text: item.text })),
                    pagination: { more: data.has_next }
                }),
                cache: true
            },
            minimumInputLength: 2,
            width: '100%'
        });

        // Simulate Button
        $('#simulate-btn').on('click', async (e) => {
            e.preventDefault();
            
            // Hide all messages
            $('#error-message, #success-message, #info-message').hide();
            $('#loading').show();
            $('#simulate-btn').html('<i class="fas fa-spinner spinner"></i> Processing...').prop('disabled', true);

            try {
                const drugId = $('#ligand').val();
                const receptorId = $('#receptor').val();

                if (!drugId || !receptorId) {
                    showError("Please select both a ligand and a receptor.");
                    return;
                }

                showInfo("Fetching molecular structures from database...");

                const [receptorResponse, ligandResponse, interactionResponse] = await Promise.all([
                    fetch(`/api/get_receptor_structure?receptor_id=${receptorId}`),
                    fetch(`/api/convert_ligand?drug_id=${drugId}`),
                    fetch(`/api/get_interaction_data?drug_id=${drugId}&receptor_id=${receptorId}`)
                ]);

                const receptorResult = await receptorResponse.json();

                if (!ligandResponse.ok) {
                    const errorData = await ligandResponse.json();
                    showError(errorData.error || "Failed to generate ligand 3D structure. Try another ligand.");
                    return;
                }

                const ligandResult = await ligandResponse.json();

                if (!interactionResponse.ok) {
                    const errorData = await interactionResponse.json();
                    showError(errorData.error || "No interaction data found for this drug-receptor pair.");
                    return;
                }

                const interactionData = await interactionResponse.json();

                // Clear viewer
                viewer.removeAllModels();
                viewer.removeAllShapes();
                viewer.removeAllLabels();
                viewer.clear();
                currentLabels = [];

                // Add receptor
                if (receptorResult.pdb) {
                    let receptorModelIndex = viewer.addModel(receptorResult.pdb, "pdb");
                    receptorModel = viewer.getModel(receptorModelIndex);
                    updateReceptorStyle();

                    // Add binding site sphere
                    if (receptorResult.binding_site && receptorResult.binding_site.x !== 0) {
                        const site = receptorResult.binding_site;
                        bindingSiteSphere = viewer.addSphere({
                            center: { x: site.x, y: site.y, z: site.z },
                            radius: 4.0,
                            color: 'yellow',
                            opacity: 0.4
                        });

                        const label = {
                            text: "Binding Site",
                            options: {
                                position: { x: site.x + 3, y: site.y + 3, z: site.z + 3 },
                                fontSize: 14,
                                fontColor: "orange",
                                backgroundColor: "rgba(255, 255, 255, 0.9)",
                                borderColor: "orange",
                                borderThickness: 2
                            }
                        };
                        currentLabels.push(label);
                        viewer.addLabel(label.text, label.options);
                    }
                }

                // Add ligand
                if (interactionData.pdb_file) {
                    const dockedResponse = await fetch(interactionData.pdb_file);
                    if (dockedResponse.ok) {
                        const dockedPdb = await dockedResponse.text();
                        let dockedModelIndex = viewer.addModel(dockedPdb, "pdb");
                        ligandModel = viewer.getModel(dockedModelIndex);
                        viewer.setStyle({ model: dockedModelIndex }, {
                            stick: { colorscheme: "greenCarbon", radius: 0.4 }
                        });

                        const center = computeModelCenter(ligandModel);
                        const label = {
                            text: "Docked Ligand",
                            options: {
                                position: { x: center.x + 2, y: center.y + 2, z: center.z + 2 },
                                fontSize: 14,
                                fontColor: "green",
                                backgroundColor: "rgba(255, 255, 255, 0.9)",
                                borderColor: "green",
                                borderThickness: 2
                            }
                        };
                        currentLabels.push(label);
                        viewer.addLabel(label.text, label.options);
                    }
                } else if (ligandResult.pdb) {
                    let ligandModelIndex = viewer.addModel(ligandResult.pdb, "pdb");
                    ligandModel = viewer.getModel(ligandModelIndex);
                    viewer.setStyle({ model: ligandModelIndex }, {
                        stick: { colorscheme: "greenCarbon", radius: 0.4 }
                    });

                    let labelText = "Ligand (Approx.)";
                    let position;

                    if (receptorResult.binding_site && receptorResult.binding_site.x !== 0) {
                        const site = receptorResult.binding_site;
                        translateModel(ligandModel, site.x, site.y, site.z);
                        position = { x: site.x + 2, y: site.y + 2, z: site.z + 2 };
                    } else {
                        const receptorCenter = computeModelCenter(receptorModel);
                        translateModel(ligandModel, receptorCenter.x + 10, receptorCenter.y + 10, receptorCenter.z + 10);
                        position = computeModelCenter(ligandModel);
                    }

                    const label = {
                        text: labelText,
                        options: {
                            position: position,
                            fontSize: 14,
                            fontColor: "green",
                            backgroundColor: "rgba(255, 255, 255, 0.9)",
                            borderColor: "green",
                            borderThickness: 2
                        }
                    };
                    currentLabels.push(label);
                    viewer.addLabel(label.text, label.options);
                }

                viewer.zoomTo();
                currentView = viewer.getView();
                viewer.render();

                // Update UI
                updateStats(interactionData);
                
                const tableBody = $('#interaction-table tbody');
                tableBody.empty();
                const row = `
                    <tr data-drug-id="${drugId}" data-receptor-id="${receptorId}">
                        <td><strong>${interactionData.ligand}</strong></td>
                        <td><span class="badge badge-info">${interactionData.receptor}</span></td>
                        <td><span class="badge badge-primary">${interactionData.affinity || "N/A"}</span></td>
                        <td><span class="badge badge-success">${interactionData.affinity_parameter || "N/A"}</span></td>
                        <td><span class="badge badge-warning">${interactionData.interaction_type || "N/A"}</span></td>
                        <td>${(interactionData.mechanism || "N/A").substring(0, 60)}...</td>
                    </tr>
                `;
                tableBody.append(row);

                $('#clear-btn').fadeIn();
                showSuccess("Interaction successfully visualized! Use controls to explore the 3D structure.");

            } catch (error) {
                console.error("ERROR:", error);
                showError("An unexpected error occurred. Please try again or contact support.");
            } finally {
                $('#loading').hide();
                $('#simulate-btn').html('<i class="fas fa-play"></i> Simulate Interaction').prop('disabled', false);
            }
        });

        // Clear Button
        $('#clear-btn').on('click', function() {
            location.reload();
        });

        // Visualization Controls
        $('#toggle-surface').on('change', updateReceptorStyle);
        $('#toggle-cartoon').on('change', updateReceptorStyle);
        $('#toggle-labels').on('change', toggleLabels);

        $('#toggle-ligand').on('change', function() {
            if (!ligandModel) return;
            const ligandModelIndex = ligandModel.id;
            if ($(this).is(':checked')) {
                viewer.setStyle({ model: ligandModelIndex }, {
                    stick: { colorscheme: "greenCarbon", radius: 0.4 }
                });
            } else {
                viewer.setStyle({ model: ligandModelIndex }, {});
            }
            viewer.render();
        });

        $('#zoom-in-btn').on('click', function() {
            if (viewer) {
                viewer.zoom(1.3);
                viewer.render();
            }
        });

        $('#zoom-out-btn').on('click', function() {
            if (viewer) {
                viewer.zoom(0.7);
                viewer.render();
            }
        });

        $('#reset-view-btn').on('click', function() {
            if (viewer) {
                viewer.zoomTo();
                viewer.render();
            }
        });

        $('#fullscreen-btn').on('click', function() {
            const viewerElement = document.getElementById('viewer');
            if (viewerElement.requestFullscreen) {
                viewerElement.requestFullscreen();
            } else if (viewerElement.webkitRequestFullscreen) {
                viewerElement.webkitRequestFullscreen();
            } else if (viewerElement.msRequestFullscreen) {
                viewerElement.msRequestFullscreen();
            }
        });

        $('#export-btn').on('click', function() {
            if (!viewer) {
                showError("No visualization to export yet!");
                return;
            }
            
            viewer.render();
            const dataUrl = viewer.pngURI();
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `receptor-ligand-${timestamp}.png`;
            link.href = dataUrl;
            link.click();
            
            showSuccess("Visualization exported successfully!");
        });

        // Table row click - zoom to ligand
        $('#interaction-table tbody').on('click', 'tr', function() {
            if (!viewer || !ligandModel || $(this).hasClass('empty-state')) return;
            
            const center = computeModelCenter(ligandModel);
            viewer.setView({
                x: center.x,
                y: center.y,
                z: center.z,
                zoom: viewer.getView().zoom * 1.5
            });
            viewer.render();
            showInfo("Zoomed to ligand binding position");
        });
    });
</script>
{% endblock %}