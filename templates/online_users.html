{% extends "base.html" %}

{% block title %}Analytics Dashboard - Drugly Admin {% endblock %}

{% block extra_css %}
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .navbar {
            background: #2c3e50 !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            padding: 15px 0;
            margin-bottom: 30px;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 600;
            color: #fff !important;
        }
        
        .nav-link {
            color: #fff !important;
            font-weight: 400;
        }
        
        .container-fluid {
            max-width: 1600px;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .period-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .period-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }
        
        .stats-card.primary::before { background: var(--primary-gradient); }
        .stats-card.danger::before { background: var(--danger-gradient); }
        .stats-card.info::before { background: var(--info-gradient); }
        .stats-card.success::before { background: var(--success-gradient); }
        .stats-card.warning::before { background: var(--warning-gradient); }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .stats-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 15px;
        }
        
        .stats-card.primary .icon { background: var(--primary-gradient); }
        .stats-card.danger .icon { background: var(--danger-gradient); }
        .stats-card.info .icon { background: var(--info-gradient); }
        .stats-card.success .icon { background: var(--success-gradient); }
        .stats-card.warning .icon { background: var(--warning-gradient); }
        
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .stats-card p {
            color: #7f8c8d;
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stats-card .change {
            font-size: 0.85rem;
            margin-top: 10px;
        }
        
        .stats-card .change.positive {
            color: #27ae60;
        }
        
        .stats-card .change.negative {
            color: #e74c3c;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: 600;
            border: none;
        }
        
        .nav-tabs {
            border: none;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs .nav-link {
            color: #495057 !important;
            font-weight: 500;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.3s;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link:hover {
            background: #f8f9fa;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-gradient);
            color: white !important;
        }
        
        .visitor-row, .user-row {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .visitor-row:hover, .user-row:hover {
            background: #f8f9fa;
            padding-left: 20px;
        }
        
        .visitor-row:last-child, .user-row:last-child {
            border-bottom: none;
        }
        
        .location-card, .page-card, .search-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .location-card:hover, .page-card:hover, .search-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }
        
        .location-bar, .progress-bar-custom {
            height: 8px;
            background: var(--primary-gradient);
            border-radius: 4px;
            margin-top: 8px;
            transition: width 0.5s ease;
        }
        
        .online-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online-badge.online {
            background: #28a745;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }
        
        .online-badge.offline {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .export-btn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .export-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner.active {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .metric-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .realtime-indicator {
            display: inline-block;
            padding: 5px 12px;
            background: #e74c3c;
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin: 10px 0;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .dropdown-menu {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
        }
        
        .badge-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
        }
</style>
{% endblock %}

{% block content %}

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>Drugly Analytics
            </a>
            <div class="ms-auto">
                <span class="realtime-indicator me-3">
                    <i class="fas fa-circle me-1"></i>LIVE
                </span>
                <a href="/" class="btn btn-outline-light me-2">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a href="/backend" class="btn btn-warning me-2">
                    <i class="fas fa-cog me-1"></i>Backend
                </a>
                <div class="btn-group me-2">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="exportData('visitors')">
                            <i class="fas fa-users me-2"></i>Visitors
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('searches')">
                            <i class="fas fa-search me-2"></i>Searches
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('drug_views')">
                            <i class="fas fa-pills me-2"></i>Drug Views
                        </a></li>
                    </ul>
                </div>
                <a href="/logout" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Period Selector -->
        <div class="period-selector">
            <button class="period-btn" data-period="today" onclick="changePeriod('today')">Today</button>
            <button class="period-btn active" data-period="week" onclick="changePeriod('week')">This Week</button>
            <button class="period-btn" data-period="month" onclick="changePeriod('month')">This Month</button>
            <button class="period-btn" data-period="year" onclick="changePeriod('year')">This Year</button>
            <button class="period-btn" data-period="all" onclick="changePeriod('all')">All Time</button>
        </div>

        <!-- Main Stats Overview -->
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card primary">
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 id="uniqueVisitors">-</h3>
                    <p>UNIQUE VISITORS</p>
                    <div class="change" id="visitorsChange"></div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card info">
                    <div class="icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h3 id="totalPageviews">-</h3>
                    <p>TOTAL PAGEVIEWS</p>
                    <div class="change" id="pageviewsChange"></div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card success">
                    <div class="icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 id="totalSearches">-</h3>
                    <p>TOTAL SEARCHES</p>
                    <div class="change" id="searchesChange"></div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card warning">
                    <div class="icon">
                        <i class="fas fa-circle"></i>
                    </div>
                    <h3 id="onlineUsers">{{ online_users|length }}</h3>
                    <p>USERS ONLINE NOW</p>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card danger">
                    <div class="icon">
                        <i class="fas fa-pills"></i>
                    </div>
                    <h3 id="totalDrugViews">-</h3>
                    <p>DRUG PAGE VIEWS</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card primary">
                    <div class="icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h3 id="totalInteractions">-</h3>
                    <p>INTERACTION CHECKS</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card success">
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <h3 id="newUsers">-</h3>
                    <p>NEW USERS</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card info">
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 id="avgPageviews">-</h3>
                    <p>AVG. PAGES/VISITOR</p>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>Visitor Trends
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="visitorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-globe me-2"></i>Top Countries
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                    <i class="fas fa-tachometer-alt me-2"></i>Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visitors-tab" data-bs-toggle="tab" data-bs-target="#visitors" type="button">
                    <i class="fas fa-chart-line me-2"></i>Visitors
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="searches-tab" data-bs-toggle="tab" data-bs-target="#searches" type="button">
                    <i class="fas fa-search me-2"></i>Searches
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="drugs-tab" data-bs-toggle="tab" data-bs-target="#drugs" type="button">
                    <i class="fas fa-pills me-2"></i>Drugs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo" type="button">
                    <i class="fas fa-globe me-2"></i>Geography
                </button>
            </li>
            <li class="nav-item" role="presentation">
    <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button">
        <i class="fas fa-mobile-alt me-2"></i>Devices
    </button>
</li>
<li class="nav-item" role="presentation">
    <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button">
        <i class="fas fa-clock me-2"></i>Sessions
    </button>
</li>
<li class="nav-item" role="presentation">
    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">
        <i class="fas fa-tachometer-alt me-2"></i>Performance
    </button>
</li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                    <i class="fas fa-users me-2"></i>Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="realtime-tab" data-bs-toggle="tab" data-bs-target="#realtime" type="button">
                    <i class="fas fa-broadcast-tower me-2"></i>Real-time
                </button>
            </li>
            <li class="nav-item" role="presentation">
    <button class="nav-link" id="clicks-tab" data-bs-toggle="tab" data-bs-target="#clicks" type="button">
        <i class="fas fa-mouse-pointer me-2"></i>Click Heatmap
    </button>
</li>
<li class="nav-item" role="presentation">
    <button class="nav-link" id="scrolls-tab" data-bs-toggle="tab" data-bs-target="#scrolls" type="button">
        <i class="fas fa-arrows-alt-v me-2"></i>Scroll Tracking
    </button>
</li>
<li class="nav-item" role="presentation">
    <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms" type="button">
        <i class="fas fa-file-signature me-2"></i>Form Analytics
    </button>
</li>
<li class="nav-item" role="presentation">
    <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button">
        <i class="fas fa-exclamation-circle me-2"></i>Error Tracking
    </button>
</li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="analyticsTabsContent">
<!-- Devices Tab -->
<div class="tab-pane fade" id="devices" role="tabpanel">
    <div class="row">
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-laptop me-2"></i>Device Types</h5>
                </div>
                <div class="card-body">
                    <canvas id="deviceTypeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-browser me-2"></i>Browsers</h5>
                </div>
                <div class="card-body">
                    <div id="browsersContainer"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>Operating Systems</h5>
                </div>
                <div class="card-body">
                    <div id="osContainer"></div>
                </div>
            </div>
        </div>
</div>
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-tv me-2"></i>Screen Resolutions</h5>
            </div>
            <div class="card-body">
                <div id="resolutionsContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Click Heatmap Tab -->
<div class="tab-pane fade" id="clicks" role="tabpanel">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-mouse-pointer me-2"></i>Click Analytics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <h3 id="totalClicks">-</h3>
                            <p class="text-muted">Total Clicks</p>
                        </div>
                        <div class="col-md-4">
                            <h3 id="avgClicksPerSession">-</h3>
                            <p class="text-muted">Avg Clicks/Session</p>
                        </div>
                        <div class="col-md-4">
                            <h3 id="clickThroughRate">-</h3>
                            <p class="text-muted">Click-Through Rate</p>
                        </div>
                    </div>
                    <h6 class="mb-3">Most Clicked Elements</h6>
                    <div id="topClickedElements"></div>
                    <h6 class="mt-4 mb-3">Click Heatmap Data</h6>
                    <div id="clickHeatmap"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scroll Tracking Tab -->
<div class="tab-pane fade" id="scrolls" role="tabpanel">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-arrows-alt-v me-2"></i>Scroll Depth by Page</h5>
                </div>
                <div class="card-body">
                    <div id="scrollDepthContainer"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Scroll Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="scrollDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forms Tab -->
<div class="tab-pane fade" id="forms" role="tabpanel">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-file-signature me-2"></i>Form Submission Analytics</h5>
                </div>
                <div class="card-body">
                    <div id="formStatsContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Errors Tab -->
<div class="tab-pane fade" id="errors" role="tabpanel">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Top Errors</h5>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="errorsLoading">
                        <div class="spinner-border text-danger"></div>
                    </div>
                    <div id="topErrorsContainer"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-browser me-2"></i>Errors by Browser</h5>
                </div>
                <div class="card-body">
                    <div id="errorsByBrowserContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Recent Errors</h5>
                </div>
                <div class="card-body">
                    <div id="recentErrorsContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Sessions Tab -->
<div class="tab-pane fade" id="sessions" role="tabpanel">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-hourglass-half me-2"></i>Session Duration</h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionDurationChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Pages per Session</h5>
                </div>
                <div class="card-body">
                    <canvas id="pagesPerSessionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Session Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 id="totalSessions">-</h3>
                            <p class="text-muted">Total Sessions</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="avgDuration">-</h3>
                            <p class="text-muted">Avg Duration</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="avgPages">-</h3>
                            <p class="text-muted">Avg Pages/Session</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="bounceRate">-</h3>
                            <p class="text-muted">Bounce Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Performance Tab -->
<div class="tab-pane fade" id="performance" role="tabpanel">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 id="avgViewTime">-</h3>
                            <p class="text-muted">Avg Drug View Time</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="engagementRate">-</h3>
                            <p class="text-muted">Engagement Rate</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="returnRate">-</h3>
                            <p class="text-muted">Return Visitor Rate</p>
                        </div>
                        <div class="col-md-3">
                            <h3 id="returningVisitors">-</h3>
                            <p class="text-muted">Returning Visitors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Top Pages</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="topPagesLoading">
                                    <div class="spinner-border text-success"></div>
                                </div>
                                <div id="topPagesContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Top Locations</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="topLocationsLoading">
                                    <div class="spinner-border text-warning"></div>
                                </div>
                                <div id="topLocationsContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visitors Tab -->
            <div class="tab-pane fade" id="visitors" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Recent Website Visitors</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading-spinner active" id="visitorsLoading">
                            <div class="spinner-border text-primary"></div>
                        </div>
                        <div id="visitorsTable"></div>
                    </div>
                </div>
            </div>

            <!-- Searches Tab -->
            <div class="tab-pane fade" id="searches" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-search me-2"></i>Top Search Queries</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="topSearchesLoading">
                                    <div class="spinner-border text-success"></div>
                                </div>
                                <div id="topSearchesContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Zero Result Searches</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="zeroResultsLoading">
                                    <div class="spinner-border text-danger"></div>
                                </div>
                                <div id="zeroResultsContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drugs Tab -->
            <div class="tab-pane fade" id="drugs" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-pills me-2"></i>Most Viewed Drugs</h5>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner" id="drugsLoading">
                            <div class="spinner-border text-danger"></div>
                        </div>
                        <div id="drugsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-pane fade" id="geo" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-globe-americas me-2"></i>Countries</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="countriesLoading">
                                    <div class="spinner-border text-info"></div>
                                </div>
                                <div id="countriesContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-city me-2"></i>Cities</h5>
                            </div>
                            <div class="card-body">
                                <div class="loading-spinner" id="citiesLoading">
                                    <div class="spinner-border text-primary"></div>
                                </div>
                                <div id="citiesContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-circle me-2"></i>Online Users (Last 5 Minutes)</h5>
                    </div>
                    <div class="card-body p-0" id="onlineUsersList">
                        {% if online_users %}
                            {% for user in online_users %}
                            <div class="user-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="online-badge online"></span>
                                        <strong>{{ user.name }} {{ user.surname }}</strong>
                                        <span class="text-muted ms-2">({{ user.email }})</span>
                                        {% if user.is_admin %}
                                        <span class="badge bg-warning text-dark ms-2">Admin</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted">
                                        <small><i class="far fa-clock me-1"></i>{{ user.last_seen.strftime('%H:%M:%S') if user.last_seen else 'Never' }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No users currently online</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>All Registered Users</h5>
                    </div>
                    <div class="card-body p-0">
                        {% for user in all_users %}
                        <div class="user-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="online-badge {{ 'online' if user.is_online() else 'offline' }}"></span>
                                    <strong>{{ user.name }} {{ user.surname }}</strong>
                                    <span class="text-muted ms-2">({{ user.email }})</span>
                                    {% if user.is_admin %}
                                    <span class="badge bg-warning text-dark ms-2">Admin</span>
                                    {% endif %}
                                </div>
                                <div class="text-muted">
                                    <small><i class="far fa-clock me-1"></i>{{ user.last_seen.strftime('%Y-%m-%d %H:%M:%S') if user.last_seen else 'Never' }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Real-time Tab -->
            <div class="tab-pane fade" id="realtime" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-broadcast-tower me-2"></i>Live Activity
                                    <span class="realtime-indicator float-end">LIVE</span>
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="realtimeLoading">
                                    <div class="spinner-border text-danger"></div>
                                </div>
                                <div id="realtimeContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Active Now</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <h2 class="display-4" id="activeVisitorsCount">0</h2>
                                    <p class="text-muted">Active Visitors</p>
                                </div>
                                <div id="activePages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn" title="Refresh Data">
        <i class="fas fa-sync-alt"></i>
    </button>
{% endblock %}

{% block extra_js %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPeriod = 'week';
        let visitorChart = null;
        let countryChart = null;

        // Change period
        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            loadDashboard();
        }

        // Load main dashboard
        function loadDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');

            fetch(`/api/analytics/dashboard?period=${currentPeriod}`)
                .then(response => response.json())
                .then(data => {
                    // Update main stats
                    document.getElementById('uniqueVisitors').textContent = data.overview.unique_visitors.toLocaleString();
                    document.getElementById('totalPageviews').textContent = data.overview.total_pageviews.toLocaleString();
                    document.getElementById('totalSearches').textContent = data.overview.total_searches.toLocaleString();
                    document.getElementById('onlineUsers').textContent = data.overview.online_users.toLocaleString();
                    document.getElementById('totalDrugViews').textContent = data.overview.total_drug_views.toLocaleString();
                    document.getElementById('totalInteractions').textContent = data.overview.total_interaction_checks.toLocaleString();
                    document.getElementById('newUsers').textContent = data.overview.new_users.toLocaleString();
                    document.getElementById('avgPageviews').textContent = data.overview.avg_pageviews_per_visitor.toFixed(1);

                    // Update charts
                    updateVisitorChart(data.daily_breakdown);
                    updateCountryChart(data.top_countries);

                    // Update top pages and locations
                    updateTopPages(data.top_pages);
                    updateTopLocations(data.top_cities);

                    refreshBtn.classList.remove('spinning');
                })
                .catch(error => {
                    console.error('Error loading dashboard:', error);
                    refreshBtn.classList.remove('spinning');
                });
        }

        // Update visitor chart
        function updateVisitorChart(data) {
            const ctx = document.getElementById('visitorChart').getContext('2d');
            
            if (visitorChart) {
                visitorChart.destroy();
            }

            visitorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Unique Visitors',
                        data: data.map(d => d.unique_visitors),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Total Visits',
                        data: data.map(d => d.total_visits),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update country chart
        function updateCountryChart(data) {
            const ctx = document.getElementById('countryChart').getContext('2d');
            
            if (countryChart) {
                countryChart.destroy();
            }

            countryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.country),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(250, 112, 154, 0.8)',
                            'rgba(255, 179, 186, 0.8)',
                            'rgba(189, 195, 199, 0.8)',
                            'rgba(142, 68, 173, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update top pages
        function updateTopPages(pages) {
            const container = document.getElementById('topPagesContainer');
            const loading = document.getElementById('topPagesLoading');
            
            loading.classList.remove('active');
            
            if (pages && pages.length > 0) {
                const maxViews = Math.max(...pages.map(p => p.views));
                container.innerHTML = pages.map((page, index) => {
                    const percentage = (page.views / maxViews) * 100;
                    return `
                        <div class="page-card mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="flex-grow-1">
                                    <span class="badge bg-primary me-2">#${index + 1}</span>
                                    <strong>${page.url}</strong>
                                </div>
                                <span class="badge badge-pill bg-success">${page.views} views</span>
                            </div>
                            <div class="progress-bar-custom" style="width: ${percentage}%"></div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><p>No page data available</p></div>';
            }
        }

        // Update top locations
        function updateTopLocations(locations) {
            const container = document.getElementById('topLocationsContainer');
            const loading = document.getElementById('topLocationsLoading');
            
            loading.classList.remove('active');
            
            if (locations && locations.length > 0) {
                const maxCount = Math.max(...locations.map(l => l.count));
                container.innerHTML = locations.slice(0, 10).map((location, index) => {
                    const percentage = (location.count / maxCount) * 100;
                    return `
                        <div class="location-card">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="badge bg-warning text-dark me-2">#${index + 1}</span>
                                    <strong>${location.city}, ${location.country}</strong>
                                </div>
                                <span class="badge badge-pill bg-info">${location.count} visits</span>
                            </div>
                            <div class="location-bar" style="width: ${percentage}%"></div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>No location data available</p></div>';
            }
        }

        // Load visitors
// REPLACE the loadVisitors function with this enhanced version:
function loadVisitors() {
    const loading = document.getElementById('visitorsLoading');
    const container = document.getElementById('visitorsTable');
    
    loading.classList.add('active');
    
    fetch('/api/analytics/visitors?limit=100')
        .then(response => response.json())
        .then(data => {
            loading.classList.remove('active');
            
            if (data.length > 0) {
                container.innerHTML = data.map(visitor => `
                    <div class="visitor-row">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <strong>${visitor.ip_address || 'Unknown'}</strong>
                                <span class="text-muted ms-2">${visitor.country || 'Unknown'}, ${visitor.city || 'Unknown'}</span>
                                ${visitor.language ? `<span class="badge bg-info ms-2">${visitor.language}</span>` : ''}
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-link me-1"></i>${visitor.page_url || 'N/A'}
                                </small>
                                <br>
                                <small class="text-muted">
                                    ${visitor.screen_width && visitor.screen_height ? `<i class="fas fa-desktop me-1"></i>${visitor.screen_width}x${visitor.screen_height}` : ''}
                                    ${visitor.device_memory ? ` | <i class="fas fa-memory me-1"></i>${visitor.device_memory}GB RAM` : ''}
                                    ${visitor.hardware_concurrency ? ` | <i class="fas fa-microchip me-1"></i>${visitor.hardware_concurrency} cores` : ''}
                                    ${visitor.connection_type ? ` | <i class="fas fa-wifi me-1"></i>${visitor.connection_type}` : ''}
                                </small>
                                ${visitor.latitude && visitor.longitude ? `<br><small class="text-success"><i class="fas fa-map-marker-alt me-1"></i>GPS: ${visitor.latitude.toFixed(4)}, ${visitor.longitude.toFixed(4)}</small>` : ''}
                            </div>
                            <div class="text-muted text-end">
                                <small><i class="far fa-clock me-1"></i>${new Date(visitor.timestamp).toLocaleString()}</small>
                                ${visitor.referrer ? `<br><small><i class="fas fa-arrow-left me-1"></i>${visitor.referrer.substring(0, 50)}...</small>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No visitors yet</p></div>';
            }
        })
        .catch(error => {
            console.error('Error loading visitors:', error);
            loading.classList.remove('active');
        });
}

        // Load searches
        function loadSearches() {
            const topLoading = document.getElementById('topSearchesLoading');
            const zeroLoading = document.getElementById('zeroResultsLoading');
            const topContainer = document.getElementById('topSearchesContainer');
            const zeroContainer = document.getElementById('zeroResultsContainer');
            
            topLoading.classList.add('active');
            zeroLoading.classList.add('active');
            
            fetch(`/api/analytics/searches?period=${currentPeriod}`)
                .then(response => response.json())
                .then(data => {
                    topLoading.classList.remove('active');
                    zeroLoading.classList.remove('active');
                    
                    // Top searches
                    if (data.top_searches && data.top_searches.length > 0) {
                        topContainer.innerHTML = data.top_searches.map((search, index) => `
                            <div class="search-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-success me-2">#${index + 1}</span>
                                        <strong>${search.query}</strong>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary me-1">${search.count} searches</span>
                                        <span class="badge bg-info">${search.avg_results} avg results</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        topContainer.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No search data available</p></div>';
                    }
                    
                    // Zero results
                    if (data.zero_results && data.zero_results.length > 0) {
                        zeroContainer.innerHTML = data.zero_results.map((search, index) => `
                            <div class="search-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-danger me-2">#${index + 1}</span>
                                        <strong>${search.query}</strong>
                                    </div>
                                    <span class="badge bg-warning text-dark">${search.count} times</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        zeroContainer.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No zero-result searches!</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading searches:', error);
                    topLoading.classList.remove('active');
                    zeroLoading.classList.remove('active');
                });
        }

        // Load drugs
        function loadDrugs() {
            const loading = document.getElementById('drugsLoading');
            const container = document.getElementById('drugsContainer');
            
            loading.classList.add('active');
            
            fetch(`/api/analytics/drugs?period=${currentPeriod}`)
                .then(response => response.json())
                .then(data => {
                    loading.classList.remove('active');
                    
                    if (data.top_drugs && data.top_drugs.length > 0) {
                        const maxViews = Math.max(...data.top_drugs.map(d => d.views));
                        container.innerHTML = data.top_drugs.map((drug, index) => {
                            const percentage = (drug.views / maxViews) * 100;
                            return `
                                <div class="page-card mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="flex-grow-1">
                                            <span class="badge bg-danger me-2">#${index + 1}</span>
                                            <strong>${drug.name_en}</strong>
                                            ${drug.name_tr ? `<span class="text-muted ms-2">(${drug.name_tr})</span>` : ''}
                                        </div>
                                        <span class="badge badge-pill bg-primary">${drug.views} views</span>
                                    </div>
                                    <div class="progress-bar-custom" style="width: ${percentage}%"></div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><i class="fas fa-pills"></i><p>No drug view data available</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading drugs:', error);
                    loading.classList.remove('active');
                });
        }

        // Load geography
        function loadGeography() {
            const countriesLoading = document.getElementById('countriesLoading');
            const citiesLoading = document.getElementById('citiesLoading');
            const countriesContainer = document.getElementById('countriesContainer');
            const citiesContainer = document.getElementById('citiesContainer');
            
            countriesLoading.classList.add('active');
            citiesLoading.classList.add('active');
            
            fetch(`/api/analytics/geo?period=${currentPeriod}`)
                .then(response => response.json())
                .then(data => {
                    countriesLoading.classList.remove('active');
                    citiesLoading.classList.remove('active');
                    
                    // Countries
                    if (data.countries && data.countries.length > 0) {
                        const maxCount = Math.max(...data.countries.map(c => c.total_visits));
                        countriesContainer.innerHTML = data.countries.slice(0, 15).map((country, index) => {
                            const percentage = (country.total_visits / maxCount) * 100;
                            return `
                                <div class="location-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <span class="badge bg-info me-2">#${index + 1}</span>
                                            <strong>${country.country}</strong>
                                        </div>
                                        <div>
                                            <span class="badge bg-primary me-1">${country.unique_visitors} visitors</span>
                                            <span class="badge bg-success">${country.total_visits} visits</span>
                                        </div>
                                    </div>
                                    <div class="location-bar" style="width: ${percentage}%"></div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        countriesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-globe"></i><p>No country data available</p></div>';
                    }
                    
                    // Cities
                    if (data.cities && data.cities.length > 0) {
                        const maxCount = Math.max(...data.cities.map(c => c.visits));
                        citiesContainer.innerHTML = data.cities.slice(0, 15).map((city, index) => {
                            const percentage = (city.visits / maxCount) * 100;
                            return `
                                <div class="location-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <span class="badge bg-primary me-2">#${index + 1}</span>
                                            <strong>${city.city}, ${city.country}</strong>
                                            ${city.region ? `<span class="text-muted ms-2">(${city.region})</span>` : ''}
                                        </div>
                                        <span class="badge badge-pill bg-success">${city.visits} visits</span>
                                    </div>
                                    <div class="location-bar" style="width: ${percentage}%"></div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        citiesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-city"></i><p>No city data available</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading geography:', error);
                    countriesLoading.classList.remove('active');
                    citiesLoading.classList.remove('active');
                });
        }

        // Load realtime
        function loadRealtime() {
            const loading = document.getElementById('realtimeLoading');
            const container = document.getElementById('realtimeContainer');
            const activeCount = document.getElementById('activeVisitorsCount');
            const activePages = document.getElementById('activePages');
            
            loading.classList.add('active');
            
            fetch('/api/analytics/realtime')
                .then(response => response.json())
                .then(data => {
                    loading.classList.remove('active');
                    
                    activeCount.textContent = data.active_visitors;
                    
                    // Active pages
                    if (data.active_pages && data.active_pages.length > 0) {
                        activePages.innerHTML = data.active_pages.map((page, index) => `
                            <div class="mb-2">
                                <small class="text-muted">${page.url}</small>
                                <div class="d-flex justify-content-between">
                                    <div class="progress-bar-custom" style="width: 60%; height: 4px;"></div>
                                    <small class="text-muted">${page.views}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        activePages.innerHTML = '<p class="text-muted text-center">No active pages</p>';
                    }
                    
                    // Recent activity
                    if (data.recent_visitors && data.recent_visitors.length > 0) {
                        container.innerHTML = data.recent_visitors.map(visitor => `
                            <div class="visitor-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="online-badge online"></span>
                                        <strong>${visitor.country || 'Unknown'}</strong>
                                        ${visitor.city ? `<span class="text-muted ms-2">${visitor.city}</span>` : ''}
                                        <br>
                                        <small class="text-muted">${visitor.page}</small>
                                    </div>
                                    <small class="text-muted">${new Date(visitor.timestamp).toLocaleTimeString()}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><i class="fas fa-broadcast-tower"></i><p>No recent activity</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading realtime:', error);
                    loading.classList.remove('active');
                });
        }


        // Load devices
function loadDevices() {
    fetch(`/api/analytics/devices?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            // Device Type Chart
            const deviceCtx = document.getElementById('deviceTypeChart').getContext('2d');
            new Chart(deviceCtx, {
                type: 'pie',
                data: {
                    labels: data.device_types.map(d => d.type),
                    datasets: [{
                        data: data.device_types.map(d => d.count),
                        backgroundColor: ['#667eea', '#f093fb', '#4facfe']
                    }]
                }
            });
            
            // Browsers
            document.getElementById('browsersContainer').innerHTML = data.browsers.map((b, i) => `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span><strong>${b.browser}</strong></span>
                        <span class="badge bg-info">${b.count}</span>
                    </div>
                    <div class="progress-bar-custom" style="width: ${(b.count/data.browsers[0].count)*100}%; height: 6px;"></div>
                </div>
            `).join('');
            
            // Screen Resolutions
            document.getElementById('resolutionsContainer').innerHTML = data.screen_resolutions.map((res, i) => `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span><small>${res.resolution}</small></span>
                        <span class="badge bg-warning text-dark">${res.count}</span>
                    </div>
                </div>
            `).join('');

            // OS
            document.getElementById('osContainer').innerHTML = data.operating_systems.map(os => `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>${os.os}</span>
                        <span class="badge bg-success">${os.count}</span>
                    </div>
                </div>
            `).join('');
        });
}

// Load sessions
function loadSessions() {
    fetch(`/api/analytics/sessions?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalSessions').textContent = data.total_sessions.toLocaleString();
            document.getElementById('avgDuration').textContent = `${data.avg_duration_seconds}s`;
            document.getElementById('avgPages').textContent = data.avg_pages_per_session;
            document.getElementById('bounceRate').textContent = `${data.bounce_rate}%`;
            
            // Duration Chart
            const durationCtx = document.getElementById('sessionDurationChart').getContext('2d');
            new Chart(durationCtx, {
                type: 'bar',
                data: {
                    labels: data.duration_distribution.map(d => d.range),
                    datasets: [{
                        label: 'Sessions',
                        data: data.duration_distribution.map(d => d.count),
                        backgroundColor: '#667eea'
                    }]
                }
            });
            
            // Pages Chart
            const pagesCtx = document.getElementById('pagesPerSessionChart').getContext('2d');
            new Chart(pagesCtx, {
                type: 'bar',
                data: {
                    labels: data.pages_distribution.map(d => d.range),
                    datasets: [{
                        label: 'Sessions',
                        data: data.pages_distribution.map(d => d.count),
                        backgroundColor: '#f5576c'
                    }]
                }
            });
        });
}

// Load performance
function loadPerformance() {
    fetch(`/api/analytics/performance?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('avgViewTime').textContent = `${data.avg_drug_view_duration}s`;
            document.getElementById('engagementRate').textContent = `${data.engagement_rate}%`;
            document.getElementById('returnRate').textContent = `${data.return_visitor_rate}%`;
            document.getElementById('returningVisitors').textContent = data.returning_visitors.toLocaleString();
        });
}

        // Update online users
        function updateOnlineUsers() {
            fetch('/api/online-users')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('onlineUsers').textContent = data.online_count;
                    
                    const onlineUsersList = document.getElementById('onlineUsersList');
                    if (data.users.length > 0) {
                        onlineUsersList.innerHTML = data.users.map(user => `
                            <div class="user-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="online-badge online"></span>
                                        <strong>${user.name}</strong>
                                        <span class="text-muted ms-2">(${user.email})</span>
                                    </div>
                                    <small class="text-muted"><i class="far fa-clock me-1"></i>${user.last_seen ? new Date(user.last_seen).toLocaleTimeString() : 'Never'}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        onlineUsersList.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No users currently online</p></div>';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Export data
        function exportData(type) {
            window.location.href = `/api/analytics/export?type=${type}&period=${currentPeriod}`;
        }

        // Refresh all data
        function refreshAllData() {
            loadDashboard();
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            if (activeTab === '#visitors') loadVisitors();
            if (activeTab === '#searches') loadSearches();
            if (activeTab === '#drugs') loadDrugs();
            if (activeTab === '#geo') loadGeography();
            if (activeTab === '#devices') loadDevices();
            if (activeTab === '#sessions') loadSessions();
            if (activeTab === '#performance') loadPerformance();
            if (activeTab === '#clicks') loadClicks();
            if (activeTab === '#scrolls') loadScrolls();
            if (activeTab === '#forms') loadForms();
            if (activeTab === '#errors') loadErrors();
            if (activeTab === '#realtime') loadRealtime();
            updateOnlineUsers();
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', refreshAllData);

        document.getElementById('devices-tab').addEventListener('click', loadDevices);
        document.getElementById('sessions-tab').addEventListener('click', loadSessions);
        document.getElementById('performance-tab').addEventListener('click', loadPerformance);

        // Tab change listeners
        document.getElementById('visitors-tab').addEventListener('click', loadVisitors);
        document.getElementById('searches-tab').addEventListener('click', loadSearches);
        document.getElementById('drugs-tab').addEventListener('click', loadDrugs);
        document.getElementById('geo-tab').addEventListener('click', loadGeography);
        document.getElementById('realtime-tab').addEventListener('click', loadRealtime);
        document.getElementById('clicks-tab').addEventListener('click', loadClicks);
        document.getElementById('scrolls-tab').addEventListener('click', loadScrolls);
        document.getElementById('forms-tab').addEventListener('click', loadForms);
        document.getElementById('errors-tab').addEventListener('click', loadErrors);

// Load clicks analytics
// REPLACE loadClicks with this ENHANCED version:
function loadClicks() {
    fetch(`/api/analytics/clicks?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            // Calculate metrics
            const totalClicks = data.total_clicks || 0;
            const avgClicksPerSession = data.avg_clicks_per_session || 0;
            const clickThroughRate = data.click_through_rate || 0;
            
            document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
            document.getElementById('avgClicksPerSession').textContent = avgClicksPerSession.toFixed(1);
            document.getElementById('clickThroughRate').textContent = `${clickThroughRate.toFixed(1)}%`;
            
            // Top clicked elements
            if (data.top_clicked_elements && data.top_clicked_elements.length > 0) {
                document.getElementById('topClickedElements').innerHTML = data.top_clicked_elements.map((el, i) => `
                    <div class="page-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <span class="badge bg-primary me-2">#${i + 1}</span>
                                <strong>${el.element_id || el.element_tag || 'No ID'}</strong>
                                ${el.element_class ? `<span class="badge bg-secondary ms-2">${el.element_class.substring(0, 20)}</span>` : ''}
                                <br>
                                <small class="text-muted">${el.element_text ? el.element_text.substring(0, 60) + '...' : 'No text'}</small>
                            </div>
                            <span class="badge bg-success">${el.clicks} clicks</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('topClickedElements').innerHTML = '<p class="text-muted text-center">No click data available</p>';
            }
            
            // Click heatmap
            if (data.click_heatmap && data.click_heatmap.length > 0) {
                document.getElementById('clickHeatmap').innerHTML = data.click_heatmap.slice(0, 10).map((click, i) => `
                    <div class="location-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <small class="text-muted">${click.page ? click.page.substring(0, 50) : 'Unknown page'}</small><br>
                                <small><i class="fas fa-crosshairs me-1"></i>Position: (${click.x}, ${click.y})</small>
                            </div>
                            <span class="badge bg-info">${click.clicks} clicks</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('clickHeatmap').innerHTML = '<p class="text-muted text-center">No heatmap data available</p>';
            }
        })
        .catch(error => console.error('Error loading clicks:', error));
        }


// Load scrolls analytics
function loadScrolls() {
    fetch(`/api/analytics/scrolls?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            // Scroll depth by page
            if (data.avg_scroll_by_page && data.avg_scroll_by_page.length > 0) {
                const maxScroll = Math.max(...data.avg_scroll_by_page.map(s => s.avg_scroll));
                document.getElementById('scrollDepthContainer').innerHTML = data.avg_scroll_by_page.slice(0, 10).map((page, i) => {
                    const percentage = (page.avg_scroll / 100) * 100;
                    return `
                        <div class="page-card mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="flex-grow-1">
                                    <small class="text-muted">${page.page}</small>
                                </div>
                                <span class="badge bg-info">${page.avg_scroll}%</span>
                            </div>
                            <div class="progress-bar-custom" style="width: ${percentage}%; height: 6px;"></div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('scrollDepthContainer').innerHTML = '<p class="text-muted text-center">No scroll data available</p>';
            }
            
            // Scroll distribution chart
            if (data.scroll_distribution && data.scroll_distribution.length > 0) {
                const ctx = document.getElementById('scrollDistributionChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.scroll_distribution.map(d => d.range),
                        datasets: [{
                            label: 'Users',
                            data: data.scroll_distribution.map(d => d.count),
                            backgroundColor: '#4facfe'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }
        })
        .catch(error => console.error('Error loading scrolls:', error));
}

// Load forms analytics
function loadForms() {
    fetch(`/api/analytics/forms?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.forms && data.forms.length > 0) {
                document.getElementById('formStatsContainer').innerHTML = data.forms.map((form, i) => `
                    <div class="page-card mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-0">${form.name}</h6>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge bg-primary">${form.submissions} submissions</span>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge bg-info">${form.avg_time_seconds}s avg time</span>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge bg-success">${form.success_rate}% success</span>
                            </div>
                            <div class="col-md-3">
                                <div class="progress-bar-custom" style="width: ${form.success_rate}%; height: 8px;"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('formStatsContainer').innerHTML = '<p class="text-muted text-center">No form data available</p>';
            }
        })
        .catch(error => console.error('Error loading forms:', error));
}

// Load errors analytics
function loadErrors() {
    const loading = document.getElementById('errorsLoading');
    loading.classList.add('active');
    
    fetch(`/api/analytics/errors?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            loading.classList.remove('active');
            
            // Top errors
            if (data.top_errors && data.top_errors.length > 0) {
                document.getElementById('topErrorsContainer').innerHTML = data.top_errors.map((error, i) => `
                    <div class="search-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <span class="badge bg-danger me-2">#${i + 1}</span>
                                <strong>${error.message.substring(0, 60)}...</strong><br>
                                <small class="text-muted">${error.page}</small>
                            </div>
                            <span class="badge bg-warning text-dark">${error.count}x</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('topErrorsContainer').innerHTML = '<p class="text-muted text-center">No errors tracked</p>';
            }
            
            // Errors by browser
            if (data.errors_by_browser && data.errors_by_browser.length > 0) {
                document.getElementById('errorsByBrowserContainer').innerHTML = data.errors_by_browser.map(browser => `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${browser.browser}</span>
                            <span class="badge bg-danger">${browser.count}</span>
                        </div>
                        <div class="progress-bar-custom" style="width: ${(browser.count/data.errors_by_browser[0].count)*100}%; height: 6px; background: #dc3545;"></div>
                    </div>
                `).join('');
            } else {
                document.getElementById('errorsByBrowserContainer').innerHTML = '<p class="text-muted text-center">No browser error data</p>';
            }
            
            // Recent errors
            if (data.recent_errors && data.recent_errors.length > 0) {
                document.getElementById('recentErrorsContainer').innerHTML = data.recent_errors.map(error => `
                    <div class="visitor-row">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <strong class="text-danger">${error.message}</strong><br>
                                <small class="text-muted">${error.page} | ${error.browser}</small>
                            </div>
                            <small class="text-muted">${new Date(error.timestamp).toLocaleString()}</small>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('recentErrorsContainer').innerHTML = '<p class="text-muted text-center">No recent errors</p>';
            }
        })
        .catch(error => {
            console.error('Error loading errors:', error);
            loading.classList.remove('active');
        });
}

        // Initial load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadDashboard();
            updateOnlineUsers();
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            if (activeTab === '#realtime') loadRealtime();
        }, 30000);

        // Realtime tab auto-refresh (every 5 seconds when active)
        setInterval(() => {
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            if (activeTab === '#realtime') {
                loadRealtime();
            }
        }, 5000);
    </script>
</body>
{% endblock %}